<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Street Perception Survey</title>
  <style>
    :root{--accent:#2563eb;--muted:#6b7280}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:#f8fafc;color:#0f172a}
    .container{max-width:1100px;margin:20px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(15,23,42,0.06)}
    h1{font-size:20px;margin:0 0 10px}
    h2{font-size:16px;margin:0 0 12px}
    .page{display:none}
    .page.active{display:block}
    label{display:block;margin-bottom:6px;font-weight:600}
    input[type=text],select,input[type=number]{width:100%;padding:8px;border:1px solid #e6eef8;border-radius:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .buttons{display:flex;justify-content:space-between;margin-top:18px}
    button{background:var(--accent);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer}
    button.secondary{background:#eef2ff;color:#0f172a}
    .images{display:flex;gap:12px}
    .images img{width:48%;height:480px;object-fit:cover;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .pair-attr{margin-top:14px;padding:12px;border:1px dashed #e6eef8;border-radius:8px}
    .scale{display:flex;gap:8px;align-items:center;justify-content:center}
    .scale label{display:flex;flex-direction:column;align-items:center;font-weight:500}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .regions-wrap{position:relative;display:inline-block;width:100%}
    .regions-wrap img{display:block;width:100%;height:480px;object-fit:cover;border-radius:8px}
    svg.overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:auto}
    .marker-dot{fill:#ef4444;stroke:#fff;stroke-width:1}
    .marker-halo{fill:rgba(239,68,68,0.14);stroke:none}
    .marker-label{font-size:12px;fill:#fff;text-anchor:middle;pointer-events:none}
    .controls{display:flex;gap:8px;justify-content:center;margin-top:8px}
    .small{padding:6px 8px;font-size:13px}
    .points-list{font-size:13px;max-height:160px;overflow:auto;background:#f1f5f9;padding:8px;border-radius:6px}
    pre#output{white-space:pre-wrap;background:#0b1220;color:#cfe9ff;padding:12px;border-radius:8px;max-height:300px;overflow:auto}
    @media (max-width:720px){ .row{grid-template-columns:1fr} .images{flex-direction:column} button{width:48%} .buttons{flex-wrap:wrap;gap:8px} }

    .container.locked * { pointer-events: none !important; user-select: none !important; opacity: 0.6; }
    #submit-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(11,17,32,0.58); z-index: 9999; }
    #submit-overlay.show { display: flex; }
    #submit-overlay .card { width: 360px; max-width: 92%; background: #fff; padding: 18px 18px; border-radius: 12px; box-shadow: 0 12px 40px rgba(2,6,23,0.3); text-align: center; font-family: inherit; }
    #submit-overlay .title { font-weight:700; font-size:16px; margin-bottom:6px; color:#0f172a; }
    #submit-overlay .message { color:#374151; font-size:14px; margin-bottom:12px; }
    .progressbar { width:100%; height:12px; background:#eef2ff; border-radius:8px; overflow:hidden; margin-top:8px; }
    .progressbar > div { height:100%; width:0%; background: linear-gradient(90deg,#2563eb,#06b6d4); transition: width 320ms linear; border-radius:8px; }
    .spinner { display:inline-block; width:28px; height:28px; margin-left:10px; vertical-align:middle; border:3px solid rgba(37,99,235,0.18); border-top-color: #2563eb; border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #submit-overlay .status-small { margin-top:10px; font-size:13px; color:#374151; }
    #submit-overlay .card .confirm-btn { margin-top:12px; background: #10b981; border-radius:8px; padding:8px 14px; color:#fff; border:none; cursor:pointer; font-weight:600; }
    #submit-overlay .card .confirm-btn.hidden { display:none; }
    #post-submit-note { margin-top:8px; font-weight:700; color:#065f46; }
  </style>
</head>

<body data-pair-ids="">

<div id="loading-overlay" style="position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(255,255,255,0.98); z-index:10000; text-align:center; transition: opacity 0.3s;">
  <div style="font-size: 1.2rem; font-weight: 600; color: #111827;">Loading Survey...</div>
  <div style="font-size: 0.9rem; color: #6b7280; margin-top: 8px;">Initializing survey images...</div>
  <div class="spinner" style="margin-top: 16px;"></div>
  <div id="loading-error" style="display:none; margin-top: 16px; color: #b91c1c; font-weight: 600; padding:0 20px;">
    Error loading images. Please ensure images are public or refresh the page.
  </div>
</div>

<div class="container">
    <h1>Street Perception Survey</h1>

    <div id="page-1" class="page active">
      <h2>1. Participant information</h2>
      <div class="row">
        <div>
          <label for="user-id">User ID (required)</label>
          <input id="user-id" type="text" placeholder="e.g. P001" />
        </div>
        <div>
          <label for="age">Age (required)</label>
          <input id="age" type="number" min="10" max="120" />
        </div>
        <div>
          <label for="gender">Gender (required)</label>
          <select id="gender"><option value="">Please choose</option><option value="female">Female</option><option value="male">Male</option><option value="other">Other / Prefer not to say</option></select>
        </div>
        <div>
          <label for="nationality">Nationality (required)</label>
          <select id="nationality" required>
            <option value="">Please choose...</option>
            <option value="Afghanistan">Afghanistan</option><option value="Åland Islands">Åland Islands</option><option value="Albania">Albania</option><option value="Algeria">Algeria</option><option value="American Samoa">American Samoa</option><option value="Andorra">Andorra</option><option value="Angola">Angola</option><option value="Anguilla">Anguilla</option><option value="Antarctica">Antarctica</option><option value="Antigua and Barbuda">Antigua and Barbuda</option><option value="Argentina">Argentina</option><option value="Armenia">Armenia</option><option value="Aruba">Aruba</option><option value="Australia">Australia</option><option value="Austria">Austria</option><option value="Azerbaijan">Azerbaijan</option><option value="Bahamas">Bahamas</option><option value="Bahrain">Bahrain</option><option value="Bangladesh">Bangladesh</option><option value="Barbados">Barbados</option><option value="Belarus">Belarus</option><option value="Belgium">Belgium</option><option value="Belize">Belize</option><option value="Benin">Benin</option><option value="Bermuda">Bermuda</option><option value="Bhutan">Bhutan</option><option value="Bolivia">Bolivia</option><option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option><option value="Botswana">Botswana</option><option value="Bouvet Island">Bouvet Island</option><option value="Brazil">Brazil</option><option value="British Indian Ocean Territory">British Indian Ocean Territory</option><option value="Brunei Darussalam">Brunei Darussalam</option><option value="Bulgaria">Bulgaria</option><option value="Burkina Faso">Burkina Faso</option><option value="Burundi">Burundi</option><option value="Cambodia">Cambodia</option><option value="Cameroon">Cameroon</option><option value="Canada">Canada</option><option value="Cape Verde">Cape Verde</option><option value="Cayman Islands">Cayman Islands</option><option value="Central African Republic">Central African Republic</option><option value="Chad">Chad</option><option value="Chile">Chile</option><option value="China">China</option><option value="Christmas Island">Christmas Island</option><option value="Cocos (Keeling) Islands">Cocos (Keeling) Islands</option><option value="Colombia">Colombia</option><option value="Comoros">Comoros</option><option value="Congo">Congo</option><option value="Congo, The Democratic Republic of The">Congo, The Democratic Republic of The</option><option value="Cook Islands">Cook Islands</option><option value="Costa Rica">Costa Rica</option><option value="Cote D'ivoire">Cote D'ivoire</option><option value="Croatia">Croatia</option><option value="Cuba">Cuba</option><option value="Cyprus">Cyprus</option><option value="Czech Republic">Czech Republic</option><option value="Denmark">Denmark</option><option value="Djibouti">Djibouti</option><option value="Dominica">Dominica</option><option value="Dominican Republic">Dominican Republic</option><option value="Ecuador">Ecuador</option><option value="Egypt">Egypt</option><option value="El Salvador">El Salvador</option><option value="Equatorial Guinea">Equatorial Guinea</option><option value="Eritrea">Eritrea</option><option value="Estonia">Estonia</option><option value="Ethiopia">Ethiopia</option><option value="Falkland Islands (Malvinas)">Falkland Islands (Malvinas)</option><option value="Faroe Islands">Faroe Islands</option><option value="Fiji">Fiji</option><option value="Finland">Finland</option><option value="France">France</option><option value="French Guiana">French Guiana</option><option value="French Polynesia">French Polynesia</option><option value="French Southern Territories">French Southern Territories</option><option value="Gabon">Gabon</option><option value="Gambia">Gambia</option><option value="Georgia">Georgia</option><option value="Germany">Germany</option><option value="Ghana">Ghana</option><option value="Gibraltar">Gibraltar</option><option value="Greece">Greece</option><option value="Greenland">Greenland</option><option value="Grenada">Grenada</option><option value="Guadeloupe">Guadeloupe</option><option value="Guam">Guam</option><option value="Guatemala">Guatemala</option><option value="Guernsey">Guernsey</option><option value="Guinea">Guinea</option><option value="Guinea-bissau">Guinea-bissau</option><option value="Guyana">Guyana</option><option value="Haiti">Haiti</option><option value="Heard Island and Mcdonald Islands">Heard Island and Mcdonald Islands</option><option value="Holy See (Vatican City State)">Holy See (Vatican City State)</option><option value="Honduras">Honduras</option><option value="Hong Kong">Hong Kong</option><option value="Hungary">Hungary</option><option value="Iceland">Iceland</option><option value="India">India</option><option value="Indonesia">Indonesia</option><option value="Iran, Islamic Republic of">Iran, Islamic Republic of</option><option value="Iraq">Iraq</option><option value="Ireland">Ireland</option><option value="Isle of Man">Isle of Man</option><option value="Israel">Israel</option><option value="Italy">Italy</option><option value="Jamaica">Jamaica</option><option value="Japan">Japan</option><option value="Jersey">Jersey</option><option value="Jordan">Jordan</option><option value="Kazakhstan">Kazakhstan</option><option value="Kenya">Kenya</option><option value="Kiribati">Kiribati</option><option value="Korea, Democratic People's Republic of">Korea, Democratic People's Republic of</option><option value="Korea, Republic of">Korea, Republic of</option><option value="Kuwait">Kuwait</option><option value="Kyrgyzstan">Kyrgyzstan</option><option value="Lao People's Democratic Republic">Lao People's Democratic Republic</option><option value="Latvia">Latvia</option><option value="Lebanon">Lebanon</option><option value="Lesotho">Lesotho</option><option value="Liberia">Liberia</option><option value="Libyan Arab Jamahiriya">Libyan Arab Jamahiriya</option><option value="Liechtenstein">Liechtenstein</option><option value="Lithuania">Lithuania</option><option value="Luxembourg">Luxembourg</option><option value="Macao">Macao</option><option value="Macedonia, The Former Yugoslav Republic of">Macedonia, The Former Yugoslav Republic of</option><option value="Madagascar">Madagascar</option><option value="Malawi">Malawi</option><option value="Malaysia">Malaysia</option><option value="Maldives">Maldives</option><option value="Mali">Mali</option><option value="Malta">Malta</option><option value="Marshall Islands">Marshall Islands</option><option value="Martinique">Martinique</option><option value="Mauritania">Mauritania</option><option value="Mauritius">Mauritius</option><option value="Mayotte">Mayotte</option><option value="Mexico">Mexico</option><option value="Micronesia, Federated States of">Micronesia, Federated States of</option><option value="Moldova, Republic of">Moldova, Republic of</option><option value="Monaco">Monaco</option><option value="Mongolia">Mongolia</option><option value="Montenegro">Montenegro</option><option value="Montserrat">Montserrat</option><option value="Morocco">Morocco</option><option value="Mozambique">Mozambique</option><option value="Myanmar">Myanmar</option><option value="Namibia">Namibia</option><option value="Nauru">Nauru</option><option value="Nepal">Nepal</option><option value="Netherlands">Netherlands</option><option value="Netherlands Antilles">Netherlands Antilles</option><option value="New Caledonia">New Caledonia</option><option value="New Zealand">New Zealand</option><option value="Nicaragua">Nicaragua</option><option value="Niger">Niger</option><option value="Nigeria">Nigeria</option><option value="Niue">Niue</option><option value="Norfolk Island">Norfolk Island</option><option value="Northern Mariana Islands">Northern Mariana Islands</option><option value="Norway">Norway</option><option value="Oman">Oman</option><option value="Pakistan">Pakistan</option><option value="Palau">Palau</option><option value="Palestinian Territory, Occupied">Palestinian Territory, Occupied</option><option value="Panama">Panama</option><option value="Papua New Guinea">Papua New Guinea</option><option value="Paraguay">Paraguay</option><option value="Peru">Peru</option><option value="Philippines">Philippines</option><option value="Pitcairn">Pitcairn</option><option value="Poland">Poland</option><option value="Portugal">Portugal</option><option value="Puerto Rico">Puerto Rico</option><option value="Qatar">Qatar</option><option value="Reunion">Reunion</option><option value="Romania">Romania</option><option value="Russian Federation">Russian Federation</option><option value="Rwanda">Rwanda</option><option value="Saint Helena">Saint Helena</option><option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option><option value="Saint Lucia">Saint Lucia</option><option value="Saint Pierre and Miquelon">Saint Pierre and Miquelon</option><option value="Saint Vincent and The Grenadines">Saint Vincent and The Grenadines</option><option value="Samoa">Samoa</option><option value="San Marino">San Marino</option><option value="Sao Tome and Principe">Sao Tome and Principe</option><option value="Saudi Arabia">Saudi Arabia</option><option value="Senegal">Senegal</option><option value="Serbia">Serbia</option><option value="Seychelles">Seychelles</option><option value="Sierra Leone">Sierra Leone</option><option value="Singapore">Singapore</option><option value="Slovakia">Slovakia</option><option value="Slovenia">Slovenia</option><option value="Solomon Islands">Solomon Islands</option><option value="Somalia">Somalia</option><option value="South Africa">South Africa</option><option value="South Georgia and The South Sandwich Islands">South Georgia and The South Sandwich Islands</option><option value="Spain">Spain</option><option value="Sri Lanka">Sri Lanka</option><option value="Sudan">Sudan</option><option value="Suriname">Suriname</option><option value="Svalbard and Jan Mayen">Svalbard and Jan Mayen</option><option value="Swaziland">Swaziland</option><option value="Sweden">Sweden</option><option value="Switzerland">Switzerland</option><option value="Syrian Arab Republic">Syrian Arab Republic</option><option value="Taiwan, Province of China">Taiwan, Province of China</option><option value="Tajikistan">Tajikistan</option><option value="Tanzania, United Republic of">Tanzania, United Republic of</option><option value="Thailand">Thailand</option><option value="Timor-leste">Timor-leste</option><option value="Togo">Togo</option><option value="Tokelau">Tokelau</option><option value="Tonga">Tonga</option><option value="Trinidad and Tobago">Trinidad and Tobago</option><option value="Tunisia">Tunisia</option><option value="Turkey">Turkey</option><option value="Turkmenistan">Turkmenistan</option><option value="Turks and Caicos Islands">Turks and Caicos Islands</option><option value="Tuvalu">Tuvalu</option><option value="Uganda">Uganda</option><option value="Ukraine">Ukraine</option><option value="United Arab Emirates">United Arab Emirates</option><option value="United Kingdom">United Kingdom</option><option value="United States">United States</option><option value="United States Minor Outlying Islands">United States Minor Outlying Islands</option><option value="Uruguay">Uruguay</option><option value="Uzbekistan">Uzbekistan</option><option value="Vanuatu">Vanuatu</option><option value="Venezuela">Venezuela</option><option value="Viet Nam">Viet Nam</option><option value="Virgin Islands, British">Virgin Islands, British</option><option value="Virgin Islands, U.S.">Virgin Islands, U.S.</option><option value="Wallis and Futuna">Wallis and Futuna</option><option value="Western Sahara">Western Sahara</option><option value="Yemen">Yemen</option><option value="Zambia">Zambia</option><option value="Zimbabwe">Zimbabwe</option><option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label for="education">Education (optional)</label>
          <select id="education"><option value="">(optional)</option><option value="highschool">High school or lower</option><option value="bachelor">Bachelor</option><option value="master">Master</option><option value="phd">PhD</option></select>
        </div>
      </div>
      <div class="buttons"><div></div><button id="to-page-2" data-next="2" type="button">Next: Safe — Rating ▶</button></div>
    </div>

    <div id="page-2" class="page" data-attr-index="0">
      <h2>2. Safe — Pairwise comparison</h2>
      <div class="images"><img class="survey-img-1" src=""><img class="survey-img-2" src=""></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks safer?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Safe"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="1" type="button">◀ Back</button><button data-next="3" type="button">Next: mark Safe points ▶</button></div>
    </div>

    <div id="page-3" class="page" data-attr-index="0">
      <h2>3. Safe — Mark points of interest</h2>
      <p class="hint">Click on the image to add a point. To remove a point, select it then use "Delete selected".</p>
      <div class="images">
        <div style="flex:1;text-align:center">
          <div class="regions-wrap"><img id="img-Safe-1" class="survey-img-1" src="" /><svg id="ov-Safe-1" class="overlay"></svg></div>
          <div style="margin-top:8px"><strong>Image 1</strong> — Points: <span id="count-Safe-1">0</span></div>
          <div class="points-list" id="list-Safe-1"></div>
        </div>
        <div style="flex:1;text-align:center">
          <div class="regions-wrap"><img id="img-Safe-2" class="survey-img-2" src="" /><svg id="ov-Safe-2" class="overlay"></svg></div>
          <div style="margin-top:8px"><strong>Image 2</strong> — Points: <span id="count-Safe-2">0</span></div>
          <div class="points-list" id="list-Safe-2"></div>
        </div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="4" type="button">Next: Lively — Rating ▶</button></div>
    </div>

    <div id="page-4" class="page" data-attr-index="1">
      <h2>4. Lively — Pairwise comparison</h2>
      <div class="images"><img class="survey-img-1" src=""><img class="survey-img-2" src=""></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks livelier?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Lively"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="3" type="button">◀ Back</button><button data-next="5" type="button">Next: mark Lively points ▶</button></div>
    </div>
    <div id="page-5" class="page" data-attr-index="1">
      <h2>5. Lively — Mark points of interest</h2>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Lively-1" class="survey-img-1" src="" /><svg id="ov-Lively-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Lively-1">0</span></div><div class="points-list" id="list-Lively-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Lively-2" class="survey-img-2" src="" /><svg id="ov-Lively-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Lively-2">0</span></div><div class="points-list" id="list-Lively-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="6" type="button">Next: Beautiful — Rating ▶</button></div>
    </div>

    <div id="page-6" class="page" data-attr-index="2">
      <h2>6. Beautiful — Pairwise comparison</h2>
      <div class="images"><img class="survey-img-1" src=""><img class="survey-img-2" src=""></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks more beautiful?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Beautiful"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="5" type="button">◀ Back</button><button data-next="7" type="button">Next: mark Beautiful points ▶</button></div>
    </div>
    <div id="page-7" class="page" data-attr-index="2">
      <h2>7. Beautiful — Mark points of interest</h2>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Beautiful-1" class="survey-img-1" src="" /><svg id="ov-Beautiful-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Beautiful-1">0</span></div><div class="points-list" id="list-Beautiful-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Beautiful-2" class="survey-img-2" src="" /><svg id="ov-Beautiful-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Beautiful-2">0</span></div><div class="points-list" id="list-Beautiful-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="8" type="button">Next: Wealthy — Rating ▶</button></div>
    </div>

    <div id="page-8" class="page" data-attr-index="3">
      <h2>8. Wealthy — Pairwise comparison</h2>
      <div class="images"><img class="survey-img-1" src=""><img class="survey-img-2" src=""></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks wealthier?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Wealthy"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="7" type="button">◀ Back</button><button data-next="9" type="button">Next: mark Wealthy points ▶</button></div>
    </div>
    <div id="page-9" class="page" data-attr-index="3">
      <h2>9. Wealthy — Mark points of interest</h2>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Wealthy-1" class="survey-img-1" src="" /><svg id="ov-Wealthy-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Wealthy-1">0</span></div><div class="points-list" id="list-Wealthy-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Wealthy-2" class="survey-img-2" src="" /><svg id="ov-Wealthy-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Wealthy-2">0</span></div><div class="points-list" id="list-Wealthy-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="10" type="button">Next: Boring — Rating ▶</button></div>
    </div>

    <div id="page-10" class="page" data-attr-index="4">
      <h2>10. Boring — Pairwise comparison</h2>
      <div class="images"><img class="survey-img-1" src=""><img class="survey-img-2" src=""></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks more boring?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Boring"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="9" type="button">◀ Back</button><button data-next="11" type="button">Next: mark Boring points ▶</button></div>
    </div>
    <div id="page-11" class="page" data-attr-index="4">
      <h2>11. Boring — Mark points of interest</h2>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Boring-1" class="survey-img-1" src="" /><svg id="ov-Boring-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Boring-1">0</span></div><div class="points-list" id="list-Boring-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Boring-2" class="survey-img-2" src="" /><svg id="ov-Boring-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Boring-2">0</span></div><div class="points-list" id="list-Boring-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="12" type="button">Next: Depressing — Rating ▶</button></div>
    </div>

    <div id="page-12" class="page" data-attr-index="5">
      <h2>12. Depressing — Pairwise comparison</h2>
      <div class="images"><img class="survey-img-1" src=""><img class="survey-img-2" src=""></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks more depressing?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Depressing"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="11" type="button">◀ Back</button><button data-next="13" type="button">Next: mark Depressing points ▶</button></div>
    </div>
    <div id="page-13" class="page" data-attr-index="5">
      <h2>13. Depressing — Mark points of interest</h2>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Depressing-1" class="survey-img-1" src="" /><svg id="ov-Depressing-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Depressing-1">0</span></div><div class="points-list" id="list-Depressing-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Depressing-2" class="survey-img-2" src="" /><svg id="ov-Depressing-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Depressing-2">0</span></div><div class="points-list" id="list-Depressing-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="14" type="button">Next: AI guess ▶</button></div>
    </div>

    <div id="page-14" class="page">
      <h2>14. Which image is more likely generated by AI?</h2>
      <div class="images"><img id="final-img-1" class="survey-img-1" src=""><img id="final-img-2" class="survey-img-2" src=""></div>
      <div style="margin-top:12px">
        <label><input type="radio" name="ai_guess" value="1"> Image 1</label>
        <label><input type="radio" name="ai_guess" value="2"> Image 2</label>
        <label><input type="radio" name="ai_guess" value="0"> Unsure</label>
      </div>
      <div class="buttons"><button class="secondary" data-go="13" type="button">◀ Back</button>
        <div>
          <button id="finish" type="button">Finish and export ▶</button>
          <div id="post-submit-note" aria-live="polite"></div>
        </div>
      </div>
      <div style="margin-top:12px"><h3>Output</h3><pre id="output">No submission yet.</pre></div>
    </div>

</div>

<div id="submit-overlay" role="status" aria-live="polite" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-label="Submitting">
      <div style="display:flex;align-items:center;justify-content:center;">
        <div class="title" id="submit-overlay-title">Submitting…</div>
        <div class="spinner" aria-hidden="true"></div>
      </div>
      <div class="message" id="submit-overlay-message">Please wait while your response is submitted.</div>
      <div class="progressbar" aria-hidden="true"><div id="submit-overlay-progress"></div></div>
      <div class="status-small" id="submit-overlay-status" aria-hidden="true"></div>
      <button id="submit-overlay-confirm" class="confirm-btn hidden" aria-hidden="true">OK</button>
    </div>
</div>

<script>
(function() {
    'use strict';

    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKvkPVvLtx7IF420Z9RRBXXhcFMowe6AiFg_AD9plWme9D83mQNIAVDvKfgXxt3nV9/exec';
    
    const ATTRIBUTES = ['Safe', 'Lively', 'Beautiful', 'Wealthy', 'Boring', 'Depressing'];
    var state = { demographics: {}, pairwise: {}, points: {}, historyByAttr: {}, ai_guess: null };
    var active = { selectedId: null, selectedAttr: null, selectedImage: null };
    var assignedPairInfo = null;

    ATTRIBUTES.forEach(a => {
        state.points[a] = { '1.jpg': [], '2.jpg': [] };
        // [Fix 1] Init history as empty array
        state.historyByAttr[a] = [];
    });

    function q(s) { return document.querySelector(s); }
    function qa(s) { return Array.from(document.querySelectorAll(s)); }
    function uuidv4() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
    function getQueryParam(n) { try { return new URL(window.location.href).searchParams.get(n); } catch (e) { return null; } }
    
    function getProlificPid() {
        var p = getQueryParam('PROLIFIC_PID') || getQueryParam('PROLIFICID') || getQueryParam('participant_id') || getQueryParam('worker_id');
        if (p) return p.trim();
        var s = localStorage.getItem('anon_worker_id');
        if (!s) { s = 'anon-' + Math.random().toString(36).slice(2); localStorage.setItem('anon_worker_id', s); }
        return s;
    }

    function getFastDriveUrl(fileId) {
        return 'https://lh3.googleusercontent.com/d/' + fileId;
    }

    function jsonp(url, callback) {
        var cbName = 'cb_' + Math.random().toString(36).slice(2);
        window[cbName] = function(data) {
            delete window[cbName];
            var el = document.getElementById('sc-' + cbName);
            if(el) el.remove();
            callback(data);
        };
        var s = document.createElement('script');
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
        s.id = 'sc-' + cbName;
        s.onerror = function() { callback({ error: 'Network error' }); };
        document.body.appendChild(s);
    }

    function requestAssignment() {
        var workerId = getProlificPid();
        var url = APPS_SCRIPT_URL + '?action=assign&worker_id=' + encodeURIComponent(workerId);
        jsonp(url, function(data) {
            if (data && (data.pair_id || data.file_id1)) {
                assignedPairInfo = data;
                applyImages(data.file_id1, data.file_id2);
            } else {
                document.getElementById('loading-error').style.display = 'block';
                document.getElementById('loading-error').textContent = "No tasks available or error: " + (data.error || 'Unknown');
            }
        });
    }

    function applyImages(fid1, fid2) {
        if (!fid1 || !fid2) return;
        var url1 = getFastDriveUrl(fid1);
        var url2 = getFastDriveUrl(fid2);
        
        console.log("--- Images Loaded ---");
        console.log("Image 1 URL:", url1);
        console.log("Image 2 URL:", url2);

        qa('.survey-img-1').forEach(img => img.src = url1);
        qa('.survey-img-2').forEach(img => img.src = url2);

        var count = 0;
        function checkDone() {
            count++;
            if (count >= 2) {
                document.getElementById('loading-overlay').style.display = 'none';
                initOverlays();
            }
        }
        var i1 = new Image(); i1.onload = checkDone; i1.onerror = function(){ qa('.survey-img-1').forEach(img => img.src = 'https://drive.google.com/uc?export=view&id=' + fid1); checkDone(); }; i1.src = url1;
        var i2 = new Image(); i2.onload = checkDone; i2.onerror = function(){ qa('.survey-img-2').forEach(img => img.src = 'https://drive.google.com/uc?export=view&id=' + fid2); checkDone(); }; i2.src = url2;
        
        document.body.dataset.pairIds = assignedPairInfo.pair_id || ('pair_' + fid1.slice(-5));
    }

    function buildRatingControls() {
        ATTRIBUTES.forEach(attr => {
            var container = document.getElementById('rating-' + attr);
            if (!container) return;
            container.innerHTML = '';
            
            var row = document.createElement('div'); row.className='attr-row';
            var left = document.createElement('div'); left.style.minWidth='140px';
            var strong = document.createElement('strong'); strong.textContent = attr;
            left.appendChild(strong);
            row.appendChild(left);

            var scale = document.createElement('div'); scale.className='scale';
            var vals = [1,0.5,0,-0.5,-1];
            vals.forEach(function(v){
              var lab = document.createElement('label');
              lab.style.display='inline-flex'; lab.style.flexDirection='column'; lab.style.alignItems='center'; lab.style.marginRight='12px';
              var inp = document.createElement('input'); inp.type='radio'; inp.name = attr; inp.value = String(v);
              var txt = document.createTextNode(String(v));
              var small = document.createElement('small');
              if(v===1) small.textContent='1: Image1 much more';
              else if(v===0.5) small.textContent='0.5: slightly more';
              else if(v===0) small.textContent='0: equal';
              else if(v===-0.5) small.textContent='-0.5: slightly less';
              else small.textContent='-1: much less';
              lab.appendChild(inp); lab.appendChild(txt); lab.appendChild(document.createElement('br')); lab.appendChild(small);
              scale.appendChild(lab);
            });
            row.appendChild(scale);
            container.appendChild(row);

            var arrowDiv = document.createElement('div');
            arrowDiv.style.textAlign = 'center';
            arrowDiv.style.marginTop = '8px';
            arrowDiv.style.fontSize = '18px';
            arrowDiv.style.fontWeight = '700';
            arrowDiv.innerHTML = '<span style="font-size:28px; margin-right:10px">◀</span> Image 1 more    <span style="font-size:20px; padding:0 8px; background:#f1f5f9; border-radius:6px;">0</span>    Image 2 more <span style="font-size:28px; margin-left:10px">▶</span>';
            container.appendChild(arrowDiv);
        });
    }

    function renderMarkers(attr, imgKey) {
        var idx = (imgKey === '1.jpg' ? 1 : 2);
        var ov = document.getElementById(`ov-${attr}-${idx}`);
        var img = document.getElementById(`img-${attr}-${idx}`);
        if (!ov || !img) return;
        
        var pts = state.points[attr][imgKey];
        var rect = img.getBoundingClientRect();
        if(rect.width < 50) return; 

        ov.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
        ov.innerHTML = ''; 

        pts.forEach((p, i) => {
            var cx = p.x * rect.width, cy = p.y * rect.height;
            var isSel = (p.id === active.selectedId);
            var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.style.cursor = 'pointer';
            g.onclick = (e) => { e.stopPropagation(); selectPoint(attr, imgKey, p.id); };

            var halo = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            halo.setAttribute('cx',cx); halo.setAttribute('cy',cy); halo.setAttribute('r',18); halo.setAttribute('class','marker-halo');
            
            var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', cx); circle.setAttribute('cy', cy);
            circle.setAttribute('r', isSel ? 8 : 6);
            circle.setAttribute('class', 'marker-dot');
            
            var labelBg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            labelBg.setAttribute('cx',cx+12); labelBg.setAttribute('cy',cy-12); labelBg.setAttribute('r',10); labelBg.setAttribute('fill','#111'); labelBg.setAttribute('opacity',0.7);
            
            var label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', cx + 12); label.setAttribute('y', cy - 8);
            label.textContent = i + 1;
            label.setAttribute('class','marker-label');

            if(isSel) halo.setAttribute('fill','rgba(239,68,68,0.22)');
            g.appendChild(halo); g.appendChild(circle); g.appendChild(labelBg); g.appendChild(label);
            ov.appendChild(g);
        });
        
        document.getElementById(`count-${attr}-${idx}`).textContent = pts.length;
        var listEl = document.getElementById(`list-${attr}-${idx}`);
        listEl.innerHTML = pts.map((p, i) => {
            var selStyle = (p.id === active.selectedId) ? 'font-weight:bold;color:#2563eb' : '';
            return `<div style="margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;${selStyle}">
                <span>#${i+1} — x=${p.x}, y=${p.y}</span>
                <button class="small secondary" onclick="window.deletePoint('${attr}','${imgKey}',${i})">Delete</button>
            </div>`;
        }).join('');
    }

    function initOverlays() {
        ATTRIBUTES.forEach(attr => {
            ['1.jpg', '2.jpg'].forEach(k => {
                var idx = (k === '1.jpg' ? 1 : 2);
                var ov = document.getElementById(`ov-${attr}-${idx}`);
                if (!ov) return;
                ov.onclick = function(e) {
                    if(e.target.tagName !== 'svg') return;
                    var rect = ov.getBoundingClientRect();
                    var x = parseFloat(((e.clientX - rect.left) / rect.width).toFixed(4));
                    var y = parseFloat(((e.clientY - rect.top) / rect.height).toFixed(4));
                    var id = uuidv4();
                    // [Fix] Snapshot BEFORE adding
                    pushHistory(attr);
                    state.points[attr][k].push({ x: x, y: y, id: id });
                    selectPoint(attr, k, id);
                };
                renderMarkers(attr, k);
            });
        });
        window.addEventListener('resize', () => { ATTRIBUTES.forEach(a => { renderMarkers(a,'1.jpg'); renderMarkers(a,'2.jpg'); }); });
    }

    window.selectPoint = function(attr, imgKey, id) {
        active.selectedId = id; active.selectedAttr = attr; active.selectedImage = imgKey;
        renderMarkers(attr, imgKey);
    };
    window.deletePoint = function(attr, imgKey, idx) {
        // [Fix] Snapshot BEFORE deleting
        pushHistory(attr);
        state.points[attr][imgKey].splice(idx, 1);
        active.selectedId = null;
        renderMarkers(attr, imgKey);
    };

    // [Fix] Simple deep clone history mechanism
    function pushHistory(attr) {
        var snap = { '1.jpg': state.points[attr]['1.jpg'].map(p=>({...p})), '2.jpg': state.points[attr]['2.jpg'].map(p=>({...p})) };
        state.historyByAttr[attr].push(snap);
        if(state.historyByAttr[attr].length > 20) state.historyByAttr[attr].shift();
    }

    document.addEventListener('click', function(e) {
        var btn = e.target.closest('button');
        if (!btn) return;
        
        var page = btn.closest('.page');

        if (btn.dataset.next) {
            var curPage = document.querySelector('.page.active');
            if (curPage.id === 'page-1') {
                var required = [ {id:'user-id',label:'User ID'},{id:'age',label:'Age'},{id:'gender',label:'Gender'},{id:'nationality',label:'Nationality'} ];
                var missing = [];
                for(var i=0;i<required.length;i++){
                  var el = document.getElementById(required[i].id);
                  var val = el ? el.value : '';
                  if(!(val && String(val).trim())) missing.push(required[i].label);
                }
                if(missing.length){
                  alert('Please fill these required fields:\n' + missing.join('\n'));
                  return;
                }
                state.demographics = {
                    id: document.getElementById('user-id').value,
                    age: document.getElementById('age').value,
                    gender: document.getElementById('gender').value,
                    nationality: document.getElementById('nationality').value,
                    education: document.getElementById('education').value
                };
            }
            if (curPage.dataset.attrIndex) {
                var attr = ATTRIBUTES[parseInt(curPage.dataset.attrIndex)];
                var sel = document.querySelector(`input[name="${attr}"]:checked`);
                if (!sel) { alert('Please provide a rating for ' + attr + ' before continuing.'); return; }
                state.pairwise[attr] = parseFloat(sel.value);
            }
            showPage(parseInt(btn.dataset.next));
        }
        
        if (btn.dataset.go) showPage(parseInt(btn.dataset.go));
        
        if (btn.hasAttribute('data-back-to-rating')) {
            if(page && page.dataset.attrIndex) {
                var idx = parseInt(page.dataset.attrIndex);
                showPage(2 + idx * 2);
            }
        }
        
        // [Fix] Undo Logic - Pop the top and replace current state
        if (btn.hasAttribute('data-undo')) {
            if(page && page.dataset.attrIndex) {
                var attr = ATTRIBUTES[parseInt(page.dataset.attrIndex)];
                var h = state.historyByAttr[attr];
                if(h.length > 0) {
                    var last = h.pop(); // [Fix] Directly pop and use
                    state.points[attr] = { '1.jpg': last['1.jpg'].map(p=>({...p})), '2.jpg': last['2.jpg'].map(p=>({...p})) };
                    active.selectedId = null;
                    renderMarkers(attr,'1.jpg'); renderMarkers(attr,'2.jpg');
                } else {
                    alert('Nothing to undo.');
                }
            }
        }
        
        if (btn.hasAttribute('data-delete-selected')) {
            if(page && page.dataset.attrIndex) {
                var attr = ATTRIBUTES[parseInt(page.dataset.attrIndex)];
                if(active.selectedId && active.selectedAttr === attr) {
                     // [Fix] Snapshot before
                     pushHistory(attr);
                     var arr = state.points[active.selectedAttr][active.selectedImage];
                     var idx = arr.findIndex(p=>p.id===active.selectedId);
                     if(idx!==-1) {
                         arr.splice(idx, 1);
                         active.selectedId = null;
                         renderMarkers(attr, active.selectedImage);
                     }
                } else {
                    alert('No point selected. Click a point to select it first.');
                }
            }
        }
        
        if (btn.hasAttribute('data-clear')) {
            if(page && page.dataset.attrIndex) {
                var attr = ATTRIBUTES[parseInt(page.dataset.attrIndex)];
                if(!confirm('Clear all points for ' + attr + '?')) return;
                pushHistory(attr);
                state.points[attr]['1.jpg'] = []; state.points[attr]['2.jpg'] = [];
                active.selectedId = null;
                renderMarkers(attr,'1.jpg'); renderMarkers(attr,'2.jpg');
            }
        }
        
        if (btn.id === 'finish') {
            if(btn.disabled) return;
            var ai = document.querySelector('input[name="ai_guess"]:checked');
            if(!ai) { alert('Please choose which image is more likely AI-generated before submitting.'); return; }
            state.ai_guess = ai.value;
            
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            document.getElementById('submit-overlay').classList.add('show');
            submitData();
        }
    });

    function showPage(n) {
        qa('.page').forEach(p => p.classList.remove('active'));
        var next = document.getElementById('page-' + n);
        if(next) {
            next.classList.add('active');
            window.scrollTo(0,0);
            if(next.dataset.attrIndex) {
                var a = ATTRIBUTES[parseInt(next.dataset.attrIndex)];
                renderMarkers(a,'1.jpg'); renderMarkers(a,'2.jpg');
            }
        }
    }

    function submitData() {
        var payload = {
            demographics: state.demographics,
            pairwise: state.pairwise,
            points: state.points,
            ai_guess: state.ai_guess,
            pair_ids: assignedPairInfo ? [assignedPairInfo.pair_id] : [],
            meta: { timestamp: new Date().toISOString() }
        };
        var formData = new URLSearchParams();
        formData.append('payload', JSON.stringify(payload));

        fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            document.getElementById('submit-overlay-progress').style.width = '100%';
            document.getElementById('submit-overlay-status').textContent = 'Success!';
            document.getElementById('submit-overlay-confirm').classList.remove('hidden');
            
            document.getElementById('finish').textContent = 'Submitted';
            document.getElementById('post-submit-note').textContent = 'Data saved. Submission ID: ' + (data.submissionId || 'ok');
            document.getElementById('output').textContent = JSON.stringify(data, null, 2);
            
            document.getElementById('submit-overlay-confirm').onclick = function() {
                document.getElementById('submit-overlay').classList.remove('show');
            };
        })
        .catch(err => {
            document.getElementById('submit-overlay-status').textContent = 'Error: ' + err.message;
            var a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(payload)], {type:'application/json'}));
            a.download = state.demographics.id + '_backup.json';
            a.click();
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
        buildRatingControls();
        var pid = getProlificPid();
        if(pid) {
            document.getElementById('user-id').value = pid;
            document.getElementById('user-id').readOnly = true;
            document.getElementById('user-id').style.background = '#f1f5f9';
        }
        requestAssignment();
    });

})();
</script>
</body>
</html>
