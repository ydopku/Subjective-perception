<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Street Perception Survey</title>
  <style>
    :root{--accent:#2563eb;--muted:#6b7280}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:#f8fafc;color:#0f172a}
    .container{max-width:1100px;margin:20px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(15,23,42,0.06)}
    h1{font-size:20px;margin:0 0 10px}
    h2{font-size:16px;margin:0 0 12px}
    .page{display:none}
    .page.active{display:block}
    label{display:block;margin-bottom:6px;font-weight:600}
    input[type=text],select,input[type=number]{width:100%;padding:8px;border:1px solid #e6eef8;border-radius:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .buttons{display:flex;justify-content:space-between;margin-top:18px}
    button{background:var(--accent);color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer}
    button.secondary{background:#eef2ff;color:#0f172a}
    .images{display:flex;gap:12px}
    .images img{width:48%;height:auto;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .pair-attr{margin-top:14px;padding:12px;border:1px dashed #e6eef8;border-radius:8px}
    .scale{display:flex;gap:8px;align-items:center;justify-content:center}
    .scale label{display:flex;flex-direction:column;align-items:center;font-weight:500}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .regions-wrap{position:relative;display:inline-block;width:100%}
    .regions-wrap img{display:block;width:100%;height:auto;border-radius:8px}
    svg.overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:auto}
    .marker-dot{fill:#ef4444;stroke:#fff;stroke-width:1}
    .marker-halo{fill:rgba(239,68,68,0.14);stroke:none}
    .marker-label{font-size:12px;fill:#fff;text-anchor:middle;pointer-events:none}
    .controls{display:flex;gap:8px;justify-content:center;margin-top:8px}
    .small{padding:6px 8px;font-size:13px}
    .points-list{font-size:13px;max-height:160px;overflow:auto;background:#f1f5f9;padding:8px;border-radius:6px}
    pre#output{white-space:pre-wrap;background:#0b1220;color:#cfe9ff;padding:12px;border-radius:8px;max-height:300px;overflow:auto}
    @media (max-width:720px){ .row{grid-template-columns:1fr} .images{flex-direction:column} button{width:48%} .buttons{flex-wrap:wrap;gap:8px} }

    /* ---- submit overlay & lock styles ---- */
    .container.locked * {
      pointer-events: none !important;
      user-select: none !important;
      opacity: 0.6;
    }

    /* Fullscreen overlay centered card */
    #submit-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(11,17,32,0.58);
      z-index: 9999;
    }
    #submit-overlay.show {
      display: flex;
    }
    #submit-overlay .card {
      width: 360px;
      max-width: 92%;
      background: #fff;
      padding: 18px 18px;
      border-radius: 12px;
      box-shadow: 0 12px 40px rgba(2,6,23,0.3);
      text-align: center;
      font-family: inherit;
    }
    #submit-overlay .title {
      font-weight:700;
      font-size:16px;
      margin-bottom:6px;
      color:#0f172a;
    }
    #submit-overlay .message {
      color:#374151;
      font-size:14px;
      margin-bottom:12px;
    }

    /* Indeterminate-like progress bar animation (we animate width up to 90%) */
    .progressbar { width:100%; height:12px; background:#eef2ff; border-radius:8px; overflow:hidden; margin-top:8px; }
    .progressbar > div {
      height:100%;
      width:0%;
      background: linear-gradient(90deg,#2563eb,#06b6d4);
      transition: width 320ms linear;
      border-radius:8px;
    }

    /* small spinner */
    .spinner {
      display:inline-block;
      width:28px;
      height:28px;
      margin-left:10px;
      vertical-align:middle;
      border:3px solid rgba(37,99,235,0.18);
      border-top-color: #2563eb;
      border-radius:50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* small helper for success/fail text */
    #submit-overlay .status-small { margin-top:10px; font-size:13px; color:#374151; }

    /* confirm button style */
    #submit-overlay .card .confirm-btn {
      margin-top:12px;
      background: #10b981;
      border-radius:8px;
      padding:8px 14px;
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:600;
    }
    #submit-overlay .card .confirm-btn.hidden { display:none; }

  </style>
</head>
<body>
  <div class="container">
    <h1>Street Perception Survey</h1>

    <!-- Page 1: demographics -->
    <div id="page-1" class="page active">
      <h2>1. Participant information</h2>
      <div class="row">
        <div>
          <label for="user-id">User ID (required)</label>
          <input id="user-id" type="text" placeholder="e.g. P001" />
        </div>
        <div>
          <label for="age">Age (required)</label>
          <input id="age" type="number" min="10" max="120" />
        </div>
        <div>
          <label for="gender">Gender (required)</label>
          <select id="gender"><option value="">Please choose</option><option value="female">Female</option><option value="male">Male</option><option value="other">Other / Prefer not to say</option></select>
        </div>
        <div>
          <label for="nationality">Nationality (required)</label>
          <input id="nationality" type="text" placeholder="e.g. Japan" />
        </div>
        <div>
          <label for="education">Education (optional)</label>
          <select id="education"><option value="">(optional)</option><option value="highschool">High school or lower</option><option value="bachelor">Bachelor</option><option value="master">Master</option><option value="phd">PhD</option></select>
        </div>
      </div>
      <div class="buttons"><div></div><button id="to-page-2" data-next="2" type="button">Next: Safe — Rating ▶</button></div>
    </div>

    <!-- For each attribute: rating page then annotation page. We'll list them explicitly. -->

    <!-- Safe rating (page 2) -->
    <div id="page-2" class="page" data-attr-index="0">
      <h2>2. Safe — Pairwise comparison</h2>
      <div class="images"><img src="1.jpg" alt="image1"><img src="2.jpg" alt="image2"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks safer?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Safe"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="1" type="button">◀ Back</button><button data-next="3" type="button">Next: mark Safe points ▶</button></div>
    </div>

    <!-- Safe annotation (page 3) -->
    <div id="page-3" class="page" data-attr-index="0">
      <h2>3. Safe — Mark points of interest</h2>
      <p class="hint">Click on the image to add a point. To remove a point, select it then use "Delete selected" or the delete button in the list. Dragging is disabled.</p>
      <div class="images">
        <div style="flex:1;text-align:center">
          <div class="regions-wrap"><img id="img-Safe-1" src="1.jpg" alt="1" /><svg id="ov-Safe-1" class="overlay"></svg></div>
          <div style="margin-top:8px"><strong>Image 1</strong> — Points: <span id="count-Safe-1">0</span></div>
          <div class="points-list" id="list-Safe-1"></div>
        </div>
        <div style="flex:1;text-align:center">
          <div class="regions-wrap"><img id="img-Safe-2" src="2.jpg" alt="2" /><svg id="ov-Safe-2" class="overlay"></svg></div>
          <div style="margin-top:8px"><strong>Image 2</strong> — Points: <span id="count-Safe-2">0</span></div>
          <div class="points-list" id="list-Safe-2"></div>
        </div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="4" type="button">Next: Lively — Rating ▶</button></div>
    </div>

    <!-- Lively rating (4) -->
    <div id="page-4" class="page" data-attr-index="1">
      <h2>4. Lively — Pairwise comparison</h2>
      <div class="images"><img src="1.jpg" alt="image1"><img src="2.jpg" alt="image2"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks livelier?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Lively"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="3" type="button">◀ Back</button><button data-next="5" type="button">Next: mark Lively points ▶</button></div>
    </div>

    <!-- Lively annotation (5) -->
    <div id="page-5" class="page" data-attr-index="1">
      <h2>5. Lively — Mark points of interest</h2>
      <p class="hint">Click to add point. Dragging disabled. Delete via "Delete selected" or list button.</p>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Lively-1" src="1.jpg"/><svg id="ov-Lively-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Lively-1">0</span></div><div class="points-list" id="list-Lively-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Lively-2" src="1.jpg"/><svg id="ov-Lively-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Lively-2">0</span></div><div class="points-list" id="list-Lively-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="6" type="button">Next: Beautiful — Rating ▶</button></div>
    </div>

    <!-- Beautiful rating (6) -->
    <div id="page-6" class="page" data-attr-index="2">
      <h2>6. Beautiful — Pairwise comparison</h2>
      <div class="images"><img src="1.jpg" alt="image1"><img src="2.jpg" alt="image2"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks more beautiful?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Beautiful"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="5" type="button">◀ Back</button><button data-next="7" type="button">Next: mark Beautiful points ▶</button></div>
    </div>

    <!-- Beautiful annotation (7) -->
    <div id="page-7" class="page" data-attr-index="2">
      <h2>7. Beautiful — Mark points of interest</h2>
      <p class="hint">Click to add point. Dragging disabled. Delete via "Delete selected" or list button.</p>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Beautiful-1" src="1.jpg"/><svg id="ov-Beautiful-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Beautiful-1">0</span></div><div class="points-list" id="list-Beautiful-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Beautiful-2" src="2.jpg"/><svg id="ov-Beautiful-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Beautiful-2">0</span></div><div class="points-list" id="list-Beautiful-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="8" type="button">Next: Wealthy — Rating ▶</button></div>
    </div>

    <!-- Wealthy rating (8) -->
    <div id="page-8" class="page" data-attr-index="3">
      <h2>8. Wealthy — Pairwise comparison</h2>
      <div class="images"><img src="1.jpg" alt="image1"><img src="2.jpg" alt="image2"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks wealthier?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Wealthy"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="7" type="button">◀ Back</button><button data-next="9" type="button">Next: mark Wealthy points ▶</button></div>
    </div>

    <!-- Wealthy annotation (9) -->
    <div id="page-9" class="page" data-attr-index="3">
      <h2>9. Wealthy — Mark points of interest</h2>
      <p class="hint">Click to add point. Dragging disabled. Delete via "Delete selected" or list button.</p>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Wealthy-1" src="1.jpg"/><svg id="ov-Wealthy-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Wealthy-1">0</span></div><div class="points-list" id="list-Wealthy-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Wealthy-2" src="2.jpg"/><svg id="ov-Wealthy-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Wealthy-2">0</span></div><div class="points-list" id="list-Wealthy-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="10" type="button">Next: Boring — Rating ▶</button></div>
    </div>

    <!-- Boring rating (10) -->
    <div id="page-10" class="page" data-attr-index="4">
      <h2>10. Boring — Pairwise comparison</h2>
      <div class="images"><img src="1.jpg" alt="image1"><img src="2.jpg" alt="image2"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks more boring?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Boring"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="9" type="button">◀ Back</button><button data-next="11" type="button">Next: mark Boring points ▶</button></div>
    </div>

    <!-- Boring annotation (11) -->
    <div id="page-11" class="page" data-attr-index="4">
      <h2>11. Boring — Mark points of interest</h2>
      <p class="hint">Click to add point. Dragging disabled. Delete via "Delete selected" or list button.</p>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Boring-1" src="1.jpg"/><svg id="ov-Boring-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Boring-1">0</span></div><div class="points-list" id="list-Boring-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Boring-2" src="2.jpg"/><svg id="ov-Boring-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Boring-2">0</span></div><div class="points-list" id="list-Boring-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="12" type="button">Next: Depressing — Rating ▶</button></div>
    </div>

    <!-- Depressing rating (12) -->
    <div id="page-12" class="page" data-attr-index="5">
      <h2>12. Depressing — Pairwise comparison</h2>
      <div class="images"><img src="1.jpg" alt="image1"><img src="2.jpg" alt="image2"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-weight:600">Image 1</div>
        <div style="text-align:center;font-weight:700">Which image looks more depressing?</div>
        <div style="font-weight:600">Image 2</div>
      </div>
      <div class="pair-attr" id="rating-Depressing"></div>
      <div class="hint" style="margin-top:8px">Use the 5-point scale below with 0 at the center.</div>
      <div class="buttons"><button class="secondary" data-go="11" type="button">◀ Back</button><button data-next="13" type="button">Next: mark Depressing points ▶</button></div>
    </div>

    <!-- Depressing annotation (13) -->
    <div id="page-13" class="page" data-attr-index="5">
      <h2>13. Depressing — Mark points of interest</h2>
      <p class="hint">Click to add point. Dragging disabled. Delete via "Delete selected" or list button.</p>
      <div class="images">
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Depressing-1" src="1.jpg"/><svg id="ov-Depressing-1" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Depressing-1">0</span></div><div class="points-list" id="list-Depressing-1"></div></div>
        <div style="flex:1;text-align:center"><div class="regions-wrap"><img id="img-Depressing-2" src="2.jpg"/><svg id="ov-Depressing-2" class="overlay"></svg></div><div style="margin-top:8px">Points: <span id="count-Depressing-2">0</span></div><div class="points-list" id="list-Depressing-2"></div></div>
      </div>
      <div class="controls"><button class="small secondary" data-undo type="button">Undo</button><button class="small secondary" data-delete-selected type="button">Delete selected</button><button class="small secondary" data-clear type="button">Clear current attribute</button></div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">◀ Back to rating</button><button data-next="14" type="button">Next: AI guess ▶</button></div>
    </div>

    <!-- Final page 14 -->
    <div id="page-14" class="page">
      <h2>14. Which image is more likely generated by AI?</h2>
      <div class="images"><img src="1.jpg"><img src="2.jpg"></div>
      <div style="margin-top:12px">
        <label><input type="radio" name="ai_guess" value="1"> Image 1</label>
        <label><input type="radio" name="ai_guess" value="2"> Image 2</label>
        <label><input type="radio" name="ai_guess" value="0"> Unsure</label>
      </div>
      <div class="buttons"><button class="secondary" data-go="13" type="button">◀ Back</button><button id="finish" type="button">Finish and export ▶</button></div>
      <div style="margin-top:12px"><h3>Output</h3><pre id="output">No submission yet.</pre></div>
    </div>

  </div>

  <!-- Submit overlay (insert after the main .container) -->
  <div id="submit-overlay" role="status" aria-live="polite" aria-hidden="true">
    <div class="card" role="dialog" aria-modal="true" aria-label="Submitting">
      <div style="display:flex;align-items:center;justify-content:center;">
        <div class="title">Submitting…</div>
        <div class="spinner" aria-hidden="true"></div>
      </div>
      <div class="message" id="submit-overlay-message">Please wait while your response is submitted.</div>
      <div class="progressbar" aria-hidden="true"><div id="submit-overlay-progress"></div></div>
      <div class="status-small" id="submit-overlay-status" aria-hidden="true"></div>
      <button id="submit-overlay-confirm" class="confirm-btn hidden" aria-hidden="true">OK</button>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    /***** CONFIG - REPLACE THESE *****/
    // Replace APPS_SCRIPT_URL with your deployed Apps Script Web App URL (from Deploy > New deployment > Web app)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx1aPRXyQxbfC0QaVCg8ILe78Y3GuFGjwZyk_n4pMrEkiJwav0Hedal_oFHFPsAeZcV/exec'; // e.g. https://script.google.com/macros/s/XXXXX/exec

    // Optional: if you want to auto-redirect participants back to Prolific completion page after successful submit,
    // set this to the completion URL Prolific gave you:
    // e.g. 'https://app.prolific.co/submissions/complete?cc=YOUR_COMPLETION_CODE'
    const PROLIFIC_COMPLETION_URL = null;

    /***** END CONFIG *****/

    var ATTRIBUTES = ['Safe','Lively','Beautiful','Wealthy','Boring','Depressing'];

    // Global state
    var state = { demographics:{}, pairwise:{}, points:{}, historyByAttr:{}, ai_guess:null };
    var active = { selectedId:null, selectedAttr:null, selectedImage:null };

    // initialize data structures
    ATTRIBUTES.forEach(function(attr){ state.points[attr] = { '1.jpg':[], '2.jpg':[] }; state.historyByAttr[attr] = []; });

    // helpers
    function q(s){ return document.querySelector(s); }
    function qa(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
    function genId(){ return 'p' + Math.random().toString(36).substr(2,9); }
    function clonePointsForAttr(attr){ var src=state.points[attr]; return { '1.jpg': src['1.jpg'].map(function(p){ return {x:p.x,y:p.y,id:p.id}; }), '2.jpg': src['2.jpg'].map(function(p){ return {x:p.x,y:p.y,id:p.id}; }) }; }

    // read query param helper
    function getQueryParam(name) {
      try {
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      } catch(e) { return null; }
    }

    // Build rating controls for all attributes
    function buildRatingControls(){
      ATTRIBUTES.forEach(function(attr){
        var container = document.getElementById('rating-' + attr);
        if(!container) return;
        container.innerHTML = '';
        var row = document.createElement('div'); row.className='attr-row';
        var left = document.createElement('div'); left.style.minWidth='140px';
        var strong = document.createElement('strong'); strong.textContent = attr;
        left.appendChild(strong);
        row.appendChild(left);

        var scale = document.createElement('div'); scale.className='scale';
        var vals = [1,0.5,0,-0.5,-1];
        vals.forEach(function(v){
          var lab = document.createElement('label');
          lab.style.display='inline-flex'; lab.style.flexDirection='column'; lab.style.alignItems='center'; lab.style.marginRight='12px';
          var inp = document.createElement('input'); inp.type='radio'; inp.name = attr; inp.value = String(v);
          var txt = document.createTextNode(String(v));
          var small = document.createElement('small');
          if(v===1) small.textContent='1: Image1 much more';
          else if(v===0.5) small.textContent='0.5: slightly more';
          else if(v===0) small.textContent='0: equal';
          else if(v===-0.5) small.textContent='-0.5: slightly less';
          else small.textContent='-1: much less';
          lab.appendChild(inp); lab.appendChild(txt); lab.appendChild(document.createElement('br')); lab.appendChild(small);
          scale.appendChild(lab);
        });
        row.appendChild(scale);
        container.appendChild(row);

        // Add a prominent arrow hint right below the scale to make direction clear and close to controls
        var arrowDiv = document.createElement('div');
        arrowDiv.style.textAlign = 'center';
        arrowDiv.style.marginTop = '8px';
        arrowDiv.style.fontSize = '18px';
        arrowDiv.style.fontWeight = '700';
        arrowDiv.innerHTML = '<span style="font-size:28px; margin-right:10px">◀</span> Image 1 more &nbsp;&nbsp; <span style="font-size:20px; padding:0 8px; background:#f1f5f9; border-radius:6px;">0</span> &nbsp;&nbsp; Image 2 more <span style="font-size:28px; margin-left:10px">▶</span>';
        container.appendChild(arrowDiv);
      });
    }

    // per-attribute operation log
    function ensureInitialHistory(){ ATTRIBUTES.forEach(function(attr){ if(state.historyByAttr[attr].length===0) state.historyByAttr[attr].push({op:'init', snapshot: clonePointsForAttr(attr)}); }); }
    function pushOp(attr,op){ try{ state.historyByAttr[attr].push(op); if(state.historyByAttr[attr].length>400) state.historyByAttr[attr].shift(); }catch(e){ console.warn('pushOp err',e); } }

    function undoForAttr(attr){
      var h = state.historyByAttr[attr];
      if(!h || h.length<=1){ alert('There is no undoable operation on this page.'); return; }
      var last = h.pop();
      switch(last.op){
        case 'add': {
          var arr = state.points[attr][last.image];
          for(var i=0;i<arr.length;i++){ if(arr[i].id===last.id){ arr.splice(i,1); break; } }
          break;
        }
        case 'delete': {
          var arr2 = state.points[attr][last.image];
          var idx = Math.max(0, Math.min(arr2.length, last.index));
          arr2.splice(idx,0,{x:last.point.x,y:last.point.y,id:last.point.id});
          break;
        }
        case 'clear': {
          state.points[attr] = { '1.jpg': last.prev['1.jpg'].map(function(p){ return {x:p.x,y:p.y,id:p.id}; }), '2.jpg': last.prev['2.jpg'].map(function(p){ return {x:p.x,y:p.y,id:p.id}; }) };
          break;
        }
        case 'init': {
          state.points[attr] = { '1.jpg': last.snapshot['1.jpg'].map(function(p){ return {x:p.x,y:p.y,id:p.id}; }), '2.jpg': last.snapshot['2.jpg'].map(function(p){ return {x:p.x,y:p.y,id:p.id}; }) };
          break;
        }
        default: console.warn('Unknown op to undo', last); break;
      }
      active.selectedId = null; active.selectedAttr = null; active.selectedImage = null;
      renderMarkers(attr,'1.jpg'); renderMarkers(attr,'2.jpg');
    }

    // Rendering utilities
    function getOverlayEl(attr,imageName){ return document.getElementById('ov-' + attr + '-' + (imageName==='1.jpg'?1:2)); }
    function getImgEl(attr,imageName){ return document.getElementById('img-' + attr + '-' + (imageName==='1.jpg'?1:2)); }

    function findNearest(attr,imageName,clientX,clientY){
      var ov = getOverlayEl(attr,imageName);
      if(!ov) return -1;
      var rect = ov.getBoundingClientRect();
      var cx = clientX - rect.left, cy = clientY - rect.top;
      var w = rect.width, h = rect.height;
      var best=-1,bestD=Infinity;
      var arr = state.points[attr][imageName]||[];
      for(var i=0;i<arr.length;i++){
        var m=arr[i];
        var mx=m.x*w, my=m.y*h;
        var d = Math.hypot(mx-cx, my-cy);
        if(d < bestD){ bestD = d; best = i; }
      }
      return (bestD <= 18)?best:-1;
    }

    function renderMarkers(attr,imageName){
      var ov = getOverlayEl(attr,imageName);
      var img = document.getElementById('img-' + attr + '-' + (imageName==='1.jpg'?1:2));
      if(!ov || !img) return;
      var rect = img.getBoundingClientRect();
      var w = rect.width, h = rect.height;
      ov.setAttribute('width', w);
      ov.setAttribute('height', h);
      ov.setAttribute('viewBox','0 0 '+w+' '+h);
      while(ov.firstChild) ov.removeChild(ov.firstChild);
      var arr = state.points[attr][imageName] || [];
      for(var i=0;i<arr.length;i++){
        var m = arr[i];
        var cx = m.x * w, cy = m.y * h;
        var NS = 'http://www.w3.org/2000/svg';
        var halo = document.createElementNS(NS,'circle'); halo.setAttribute('cx',cx); halo.setAttribute('cy',cy); halo.setAttribute('r',18); halo.setAttribute('class','marker-halo');
        var dot = document.createElementNS(NS,'circle'); dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',(m.id===active.selectedId)?8:6); dot.setAttribute('class','marker-dot');
        dot.setAttribute('data-id',m.id); dot.setAttribute('data-attr',attr); dot.setAttribute('data-image',imageName); dot.setAttribute('style','cursor:pointer');
        var labelBg = document.createElementNS(NS,'circle'); labelBg.setAttribute('cx',cx+12); labelBg.setAttribute('cy',cy-12); labelBg.setAttribute('r',10); labelBg.setAttribute('fill','#111'); labelBg.setAttribute('opacity',0.7);
        var text = document.createElementNS(NS,'text'); text.setAttribute('x',cx+12); text.setAttribute('y',cy-8); text.setAttribute('class','marker-label'); text.textContent = String(i+1);
        if(m.id===active.selectedId) halo.setAttribute('fill','rgba(239,68,68,0.22)');
        ov.appendChild(halo); ov.appendChild(dot); ov.appendChild(labelBg); ov.appendChild(text);
      }
      updateCounts(attr);
      updateListDisplay(attr,imageName);
    }

    function updateCounts(attr){
      var el1 = document.getElementById('count-'+attr+'-1');
      var el2 = document.getElementById('count-'+attr+'-2');
      if(el1) el1.textContent = state.points[attr]['1.jpg'].length;
      if(el2) el2.textContent = state.points[attr]['2.jpg'].length;
    }

    function updateListDisplay(attr,imageName){
      var id = (imageName==='1.jpg'?1:2);
      var listEl = document.getElementById('list-'+attr+'-'+id);
      if(!listEl) return;
      listEl.innerHTML = '';
      var arr = state.points[attr][imageName] || [];
      arr.forEach(function(p,i){
        var div = document.createElement('div');
        div.textContent = '#'+(i+1) + ' — x=' + p.x + ', y=' + p.y;
        var btn = document.createElement('button'); btn.textContent = 'Delete'; btn.style.marginLeft='8px';
        btn.addEventListener('click', function(){
          var removed = arr.splice(i,1)[0];
          pushOp(attr,{op:'delete', image:imageName, index:i, point: removed});
          renderMarkers(attr,imageName);
        });
        div.appendChild(btn);
        listEl.appendChild(div);
      });
    }

    function refreshAll(){ ATTRIBUTES.forEach(function(a){ renderMarkers(a,'1.jpg'); renderMarkers(a,'2.jpg'); }); }

    // Setup overlay (click to add/select). Drag disabled.
    function setupOverlay(attr,imageName){
      var imgId = 'img-' + attr + '-' + (imageName==='1.jpg'?1:2);
      var ovId = 'ov-' + attr + '-' + (imageName==='1.jpg'?1:2);
      var img = document.getElementById(imgId);
      var ov = document.getElementById(ovId);
      if(!img || !ov) return;
      function resize(){
        var r = img.getBoundingClientRect();
        ov.setAttribute('width', r.width);
        ov.setAttribute('height', r.height);
        ov.setAttribute('viewBox','0 0 '+r.width+' '+r.height);
        renderMarkers(attr,imageName);
      }
      img.addEventListener('load', resize);
      window.addEventListener('resize', resize);
      if(img.complete) setTimeout(resize,50);

      ov.addEventListener('click', function(ev){
        var nearest = findNearest(attr,imageName,ev.clientX,ev.clientY);
        if(nearest >= 0){
          var m = state.points[attr][imageName][nearest];
          active.selectedId = m.id; active.selectedAttr = attr; active.selectedImage = imageName;
          renderMarkers(attr,imageName);
        } else {
          var rect = ov.getBoundingClientRect();
          var cx = ev.clientX - rect.left;
          var cy = ev.clientY - rect.top;
          var nx = +(cx/rect.width).toFixed(4);
          var ny = +(cy/rect.height).toFixed(4);
          var id = genId();
          var p = { x: nx, y: ny, id: id };
          state.points[attr][imageName].push(p);
          active.selectedId = id; active.selectedAttr = attr; active.selectedImage = imageName;
          renderMarkers(attr,imageName);
          pushOp(attr,{op:'add', image: imageName, id: id, point: p});
        }
      });
    }

    function initAllOverlays(){ ATTRIBUTES.forEach(function(attr){ setupOverlay(attr,'1.jpg'); setupOverlay(attr,'2.jpg'); }); }

    // Controls binding
    function bindControls(){
      qa('[data-undo]').forEach(function(b){
        b.addEventListener('click', function(){
          var page = b.closest('.page');
          if(!page || typeof page.dataset.attrIndex==='undefined'){ alert('No attribute on this page.'); return; }
          var idx = parseInt(page.dataset.attrIndex,10);
          var attr = ATTRIBUTES[idx];
          undoForAttr(attr);
        });
      });

      qa('[data-delete-selected]').forEach(function(b){
        b.addEventListener('click', function(){
          var page = b.closest('.page');
          if(!page || typeof page.dataset.attrIndex==='undefined') return;
          var idx = parseInt(page.dataset.attrIndex,10);
          var attr = ATTRIBUTES[idx];
          if(!active.selectedId || active.selectedAttr !== attr) { alert('No selected point on this page.'); return; }
          var imgs = ['1.jpg','2.jpg'];
          for(var i=0;i<imgs.length;i++){
            var arr = state.points[attr][imgs[i]];
            for(var j=0;j<arr.length;j++){
              if(arr[j].id === active.selectedId){
                var removed = arr.splice(j,1)[0];
                pushOp(attr,{op:'delete', image: imgs[i], index: j, point: removed});
                active.selectedId = null; active.selectedAttr = null; active.selectedImage = null;
                renderMarkers(attr,'1.jpg'); renderMarkers(attr,'2.jpg');
                return;
              }
            }
          }
        });
      });

      qa('[data-clear]').forEach(function(b){
        b.addEventListener('click', function(){
          var page = b.closest('.page');
          if(!page || typeof page.dataset.attrIndex==='undefined'){
            if(!confirm('Clear all attributes on all pages? This cannot be undone.')) return;
            ATTRIBUTES.forEach(function(a){ pushOp(a,{op:'clear', prev: clonePointsForAttr(a)}); state.points[a] = {'1.jpg':[],'2.jpg':[]}; });
            refreshAll();
            return;
          }
          var idx = parseInt(page.dataset.attrIndex,10);
          var attr = ATTRIBUTES[idx];
          if(!confirm('Clear all points for ' + attr + '?')) return;
          pushOp(attr,{op:'clear', prev: clonePointsForAttr(attr)});
          state.points[attr] = {'1.jpg':[],'2.jpg':[]};
          renderMarkers(attr,'1.jpg'); renderMarkers(attr,'2.jpg');
        });
      });
    }

    // Navigation
    function showPage(n){
      qa('.page').forEach(function(p){ p.classList.remove('active'); });
      var el = document.getElementById('page-' + n);
      if(!el) return;
      el.classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
      try{
        if(el.dataset && typeof el.dataset.attrIndex !== 'undefined'){
          var idx = parseInt(el.dataset.attrIndex,10);
          var attr = ATTRIBUTES[idx];
          renderMarkers(attr,'1.jpg'); renderMarkers(attr,'2.jpg');
        }
      }catch(e){ console.warn(e); }
    }

    function bindNavigation(){
      document.addEventListener('click', function(ev){
        var elNext = ev.target.closest && ev.target.closest('[data-next]');
        var elGo = ev.target.closest && ev.target.closest('[data-go]');
        var elBackToRating = ev.target.closest && ev.target.closest('[data-back-to-rating]');

        if(elNext){
          ev.preventDefault();
          var page = elNext.closest('.page');

          // Page 1 validation
          if(page && page.id === 'page-1'){
            var required = [ {id:'user-id',label:'User ID'},{id:'age',label:'Age'},{id:'gender',label:'Gender'},{id:'nationality',label:'Nationality'} ];
            var missing = [];
            for(var i=0;i<required.length;i++){
              var el = document.getElementById(required[i].id);
              var val = el ? el.value : '';
              if(!(val && String(val).trim())) missing.push(required[i].label);
            }
            if(missing.length){
              alert('Please fill these required fields:\n' + missing.join('\n'));
              return;
            }
            state.demographics = { id: (q('#user-id')||{}).value.trim(), age: parseInt((q('#age')||{}).value,10), gender: (q('#gender')||{}).value, nationality: (q('#nationality')||{}).value.trim(), education: (q('#education')||{}).value || null };
            var next = parseInt(elNext.dataset.next,10);
            showPage(next);
            return;
          }

          // Rating page validation
          if(page && page.dataset && typeof page.dataset.attrIndex !== 'undefined'){
            var idx = parseInt(page.dataset.attrIndex,10);
            var attr = ATTRIBUTES[idx];
            var valEl = document.querySelector('input[name="' + attr + '"]:checked');
            if(!valEl){
              alert('Please provide a rating for ' + attr + ' before continuing.');
              return;
            }
            state.pairwise[attr] = parseFloat(valEl.value);
            var next2 = parseInt(elNext.dataset.next,10);
            showPage(next2);
            return;
          }

          var next3 = parseInt(elNext.dataset.next,10);
          if(!isNaN(next3)) showPage(next3);
          return;
        }

        if(elBackToRating){
          ev.preventDefault();
          var page = elBackToRating.closest('.page');
          if(page && page.dataset && typeof page.dataset.attrIndex !== 'undefined'){
            var idx2 = parseInt(page.dataset.attrIndex,10);
            showPage(2 + idx2*2);
          }
          return;
        }

        if(elGo){
          ev.preventDefault();
          var target = parseInt(elGo.dataset.go,10);
          if(!isNaN(target)) showPage(target);
          return;
        }
      });
    }

    // Submit helper: tries to POST to Apps Script (form-encoded 'payload'), falls back to local download
    async function submitResponse(payload) {
      // Ensure we include PROLIFIC params if present
      payload.prolific_pid = payload.prolific_pid || getQueryParam('PROLIFIC_PID') || getQueryParam('PROLIFICID') || null;
      payload.pid = payload.pid || getQueryParam('pid') || (payload.demographics && payload.demographics.id) || null;
      payload.submitted_at = new Date().toISOString();

      // If APPS_SCRIPT_URL not configured, skip attempt
      if(!APPS_SCRIPT_URL || APPS_SCRIPT_URL.indexOf('PASTE_YOUR_APPS') === 0) {
        console.warn('APPS_SCRIPT_URL not set; skipping remote submit and falling back to local download.');
        await fallbackDownload(payload);
        return { ok: false, fallback: true, message: 'No endpoint configured' };
      }

      try {
        // Use application/x-www-form-urlencoded by posting a single field 'payload' with JSON string
        const form = new URLSearchParams();
        form.append('payload', JSON.stringify(payload));

        // timeout helper
        const controller = new AbortController();
        const timeoutId = setTimeout(()=>controller.abort(), 12000);

        const resp = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: form,
          signal: controller.signal
          // do NOT set custom Content-Type header; let browser set application/x-www-form-urlencoded
        });
        clearTimeout(timeoutId);

        if(!resp.ok) {
          // treat as failure
          throw new Error('HTTP status ' + resp.status);
        }

        // Try parse response JSON
        let j = {};
        try { j = await resp.json(); } catch(e) { j = {}; }
        if(j.status && j.status === 'ok') {
          // Return structured success (no browser alert)
          return { ok: true, server: j, message: 'Response successfully submitted.' };
        } else {
          // Unexpected server response - treat as failure
          console.warn('Unexpected server response', j);
          throw new Error('Unexpected server response');
        }
      } catch (err) {
        console.warn('Remote submit failed:', err);
        await fallbackDownload(payload);
        return { ok: false, fallback: true, message: err.message || 'Submit failed' };
      }
    }

    async function fallbackDownload(payload) {
      // Create JSON file and trigger download (no alert)
      const jsonStr = JSON.stringify(payload, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const fname = (payload && payload.demographics && payload.demographics.id ? payload.demographics.id : 'response') + '_survey.json';
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); document.body.removeChild(a); }, 1500);
      // return info for caller
      return { ok: false, fallback: true, filename: fname };
    }

    /* ---------- Submission overlay controls (with confirm button) ---------- */
    (function(){
      var overlay = null, progressEl = null, messageEl = null, statusEl = null, confirmBtn = null;
      var animTimer = null;
      var simulatedProgress = 0;
      var lastSuccess = false;

      function getOverlayEls() {
        if (!overlay) {
          overlay = document.getElementById('submit-overlay');
          progressEl = document.getElementById('submit-overlay-progress');
          messageEl = document.getElementById('submit-overlay-message');
          statusEl = document.getElementById('submit-overlay-status');
          confirmBtn = document.getElementById('submit-overlay-confirm');
          if(confirmBtn){
            confirmBtn.addEventListener('click', function(){
              // on confirm, hide overlay and optionally redirect
              hideOverlayImmediately();
              if(lastSuccess && PROLIFIC_COMPLETION_URL){
                // small delay for UX
                setTimeout(function(){ window.location.href = PROLIFIC_COMPLETION_URL; }, 250);
              }
            });
          }
        }
      }

      function hideOverlayImmediately(){
        if (!overlay) return;
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
        var cont = document.querySelector('.container');
        if (cont) cont.classList.remove('locked');
        try { if(progressEl) progressEl.style.width = '0%'; }catch(e){}
        if(statusEl) statusEl.textContent = '';
        if(confirmBtn) { confirmBtn.classList.add('hidden'); confirmBtn.setAttribute('aria-hidden','true'); }
      }

      // show overlay and start simulated progress
      window.showSubmittingOverlay = function(message) {
        getOverlayEls();
        // lock UI
        var cont = document.querySelector('.container');
        if (cont) cont.classList.add('locked');

        if (!overlay) return;
        overlay.setAttribute('aria-hidden','false');
        overlay.classList.add('show');
        messageEl.textContent = message || 'Submitting... please wait';
        statusEl.textContent = '';
        if(confirmBtn) { confirmBtn.classList.add('hidden'); confirmBtn.setAttribute('aria-hidden','true'); }

        // start simulated progress from small positive
        simulatedProgress = 4;
        progressEl.style.width = simulatedProgress + '%';
        // increase slowly toward 90%
        clearInterval(animTimer);
        animTimer = setInterval(function(){
          var inc = 1 + Math.random()*6;
          simulatedProgress = Math.min(90, simulatedProgress + inc);
          progressEl.style.width = simulatedProgress + '%';
        }, 350);
      };

      // show final status: if success -> show confirm button and don't auto-hide.
      // if failure -> show message and auto-hide after a short delay.
      window.hideSubmittingOverlay = function(success, finalMessage) {
        getOverlayEls();
        clearInterval(animTimer);
        lastSuccess = !!success;
        // set to 100% quickly
        try { progressEl.style.width = '100%'; } catch(e){}
        // show final message
        if (statusEl) statusEl.textContent = finalMessage || (success ? 'Submitted.' : 'Submission failed.');
        if(success){
          // show confirm button (user must click)
          if(confirmBtn){ confirmBtn.classList.remove('hidden'); confirmBtn.setAttribute('aria-hidden','false'); }
          // keep overlay visible until user confirms
        } else {
          // auto hide after a short pause
          setTimeout(function(){
            hideOverlayImmediately();
          }, 1400);
        }
      };

    })(); // end overlay controls IIFE

    /* --------- Replace existing bindFinish with this version (updates output display) --------- */
    function bindFinish(){
      var finish = document.getElementById('finish');
      if(!finish) return;
      finish.addEventListener('click', async function(){
        var sel = document.querySelector('input[name="ai_guess"]:checked');
        if(!sel){ alert('Please choose which image is more likely AI-generated before submitting.'); return; }
        state.ai_guess = sel.value;
        var payload = { demographics: state.demographics, pairwise: state.pairwise, points: state.points, ai_guess: state.ai_guess, meta: { timestamp: new Date().toISOString() } };

        // update Output area immediately so user sees what's being submitted
        var outEl = document.getElementById('output');
        if(outEl) outEl.textContent = JSON.stringify(payload, null, 2);

        // show overlay and lock UI
        showSubmittingOverlay('Submitting your response — please wait.');

        // call submitResponse and process structured result (no alerts in submitResponse)
        let res = { ok:false };
        try {
          res = await submitResponse(payload); // returns object {ok: true/false, message, ...}
        } catch(err) {
          console.error('submitResponse threw error', err);
          res = { ok: false, fallback: true, message: (err && err.message) ? err.message : 'Unknown error' };
        }

        // Show appropriate final overlay state
        if(res.ok){
          // success: set final message and show confirm button on overlay
          hideSubmittingOverlay(true, 'Submission complete.');
        } else if(res.fallback){
          hideSubmittingOverlay(false, 'Submission failed — response saved locally.');
        } else {
          hideSubmittingOverlay(false, 'Submission failed.');
        }
      });
    }

    // Init
    window.addEventListener('DOMContentLoaded', function(){
      buildRatingControls();
      ensureInitialHistory();
      initAllOverlays();
      bindControls();
      bindNavigation();
      bindFinish();
      console.log('Survey ready (with Apps Script submit integration and improved overlay).');
    });

    // Expose for debugging
    window._survey = { state: state, showPage: showPage, renderAll: refreshAll };

  })();
  </script>
</body>
</html>

