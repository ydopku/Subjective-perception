<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Street Perception Survey</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <style>
    :root {
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --muted: #64748b;
      --pos: #22c55e;
      --neg: #ef4444;
      --bg-gray: #f8fafc;
      --text-main: #0f172a;
      --font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    body {
      font-family: var(--font-family);
      margin: 0;
      background: var(--bg-gray);
      color: var(--text-main);
      font-size: 16px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 40px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
    }

    h1 { font-size: 32px; margin: 0 0 24px; font-weight: 800; color: #1e293b; letter-spacing: -0.02em; }
    h2 { font-size: 24px; margin: 0 0 24px; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 12px; font-weight: 700; }
    h3 { font-size: 18px; font-weight: 700; color: #475569; margin-top: 0; }
    p { margin-bottom: 16px; color: #475569; }

    .page { display: none; animation: fadeIn 0.4s ease-out; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* Ë°®ÂçïÊéß‰ª∂ */
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 16px; color: #334155; }
    input[type=text], select, input[type=number] {
      width: 100%; padding: 14px 16px; border: 1px solid #cbd5e1;
      border-radius: 10px; box-sizing: border-box; font-size: 16px;
      transition: all 0.2s; background: #fff;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }

    /* ÊåâÈíÆÊ†∑Âºè */
    .buttons { display: flex; justify-content: space-between; margin-top: 50px; padding-top: 30px; border-top: 1px solid #f1f5f9; }
    button {
      background: var(--accent); color: #fff; padding: 16px 28px;
      border: none; border-radius: 10px; cursor: pointer;
      font-weight: 600; font-size: 16px; letter-spacing: 0.01em;
      transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(37,99,235,0.2);
    }
    button:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 6px 12px -2px rgba(37,99,235,0.3); }
    button:active { transform: translateY(0); }
    
    button.secondary { background: #f1f5f9; color: #475569; box-shadow: none; border: 1px solid #e2e8f0; }
    button.secondary:hover { background: #e2e8f0; color: #1e293b; border-color: #cbd5e1; }
    button:disabled { background: #cbd5e1; color: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }

    .definition-box {
      background: #eff6ff; border-left: 6px solid var(--accent);
      padding: 20px; margin-bottom: 30px; border-radius: 8px;
      color: #1e40af; font-size: 16px; line-height: 1.6;
    }

    /* --- Ê†∏ÂøÉÂõæÁâáÂÆπÂô®‰øÆÂ§ç --- */
    /* ÁõÆÊ†áÔºöÁ°Æ‰øù‰∏§Âº†ÂõæÈ´òÂ∫¶‰∏ÄËá¥Ôºå‰∏îÂ∞ΩÂèØËÉΩÂà©Áî®Á©∫Èó¥ */
    .images { 
      display: flex; 
      gap: 15px; /* ÂáèÂ∞èÈó¥Ë∑ùÔºåÁªôÂõæÁâáÊõ¥Â§öÂÆΩÂ∫¶ */
      justify-content: space-between; 
      height: 550px; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
      margin-bottom: 30px; 
      align-items: stretch; 
    }
    .img-wrapper, .regions-wrap { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      position: relative; 
      width: 100%;
      background: #f1f5f9; /* ‰ΩøÁî®Ê∑°ÁÅ∞Ëâ≤ËÉåÊôØÔºåÈÅøÂÖçÊ∑±Ëâ≤Ëøá‰∫éÂéãÊäë */
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      overflow: hidden; 
      padding: 0; /* ÁßªÈô§ÂÜÖËæπË∑ùÔºåËÆ©ÂõæÁâáÈ°∂Êª° */
      box-sizing: border-box;
    }
    .images img, .regions-wrap img { 
      height: 100%; /* Âº∫Âà∂Âç†Êª°È´òÂ∫¶ */
      width: auto; 
      max-width: 100%; 
      object-fit: contain; /* ‰øùÊåÅÊØî‰æãÔºå‰∏ç‰ºöË¢´Ë£ÅÂâ™ */
      display: block;
    }
    
    .regions-wrap { line-height: 0; display: inline-flex; }
    .canvas-container { position: absolute !important; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; }

    /* ËØÑÂàÜÂàóË°® */
    .rating-list { display: flex; flex-direction: column; gap: 14px; max-width: 750px; margin: 0 auto; }
    .rating-option {
      display: flex; align-items: center; padding: 18px 24px;
      border: 2px solid #e2e8f0; border-radius: 12px;
      cursor: pointer; transition: all 0.2s; background: #fff;
    }
    .rating-option:hover { border-color: #93c5fd; background: #f8fafc; }
    .rating-option.selected { border-color: var(--accent); background: #eff6ff; box-shadow: 0 0 0 4px rgba(37,99,235,0.1); }
    .rating-option input { width: 22px; height: 22px; margin-right: 18px; accent-color: var(--accent); }
    .rating-option span { font-size: 17px; color: #334155; font-weight: 500; }

    /* ÂúàÈÄâÂ∑•ÂÖ∑Ê†è */
    .circling-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; font-size: 15px; color: var(--muted);
      background: #f8fafc; padding: 14px 24px; border-radius: 10px; border: 1px solid #e2e8f0;
    }
    .legend span { display: inline-flex; align-items: center; margin-left: 24px; font-weight: 600; }
    .legend .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 8px; }

    .controls-toolbar {
      display: flex; gap: 14px; justify-content: center; margin-top: 24px;
      padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; flex-wrap: wrap;
    }
    .controls-toolbar button.small { padding: 10px 20px; font-size: 15px; display: flex; align-items: center; gap: 8px; height: 44px; }
    .btn-toggle { background: #fff; border: 1px solid #cbd5e1; color: #334155; }
    .btn-toggle:not(:disabled):hover { border-color: var(--accent); color: var(--accent); background: #eff6ff; }
    .btn-delete { background: #fff; border: 1px solid #cbd5e1; color: var(--neg); }
    .btn-delete:not(:disabled):hover { background: #fef2f2; border-color: var(--neg); }

    /* ÂúàÈÄâÂêåÊ≠•ÂàóË°® */
    .region-list-container { margin-top: 24px; display: flex; gap: 30px; border-top: 1px dashed #e2e8f0; padding-top: 24px; }
    .region-col { flex: 1; }
    .region-col h4 { font-size: 14px; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; margin-bottom: 12px; }
    .region-items { display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; }
    .region-item {
      padding: 12px 16px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;
      cursor: pointer; display: flex; justify-content: space-between; align-items: center;
      font-size: 15px; transition: all 0.15s;
    }
    .region-item:hover { background: #f1f5f9; border-color: #cbd5e1; }
    .region-item.active { border-color: var(--accent); background: #eff6ff; font-weight: 600; box-shadow: 0 2px 5px rgba(37,99,235,0.1); }
    .region-item.pos { border-left: 6px solid var(--pos); }
    .region-item.neg { border-left: 6px solid var(--neg); }

    /* Global Factor Section */
    .global-factor-section { 
        margin-top: 30px; 
        padding: 24px; 
        background: #fff7ed; /* Ê©ôËâ≤ËÉåÊôØ */
        border: 1px solid #fed7aa; /* Ê©ôËâ≤ËæπÊ°Ü */
        border-radius: 12px; 
    }
    .global-factor-section h3 { color: #9a3412; } 
    
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 16px; }
    .checkbox-item {
      display: flex; align-items: center; background: #fff; padding: 10px 16px;
      border-radius: 8px; border: 1px solid #fdba74; cursor: pointer;
      font-size: 15px; color: #7c2d12; transition: all 0.2s;
    }
    .checkbox-item:hover { background: #ffedd5; }
    .checkbox-item input { width: 18px; height: 18px; margin-right: 10px; accent-color: #ea580c; }

    /* Ê£ÄÊü•È°µ */
    .check-section { border: 1px solid #e2e8f0; padding: 30px; border-radius: 12px; background: #fff; margin-bottom: 30px; }
    .check-row { display: flex; gap: 20px; margin-bottom: 30px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 30px; }
    .check-pair { flex: 1; display: flex; gap: 30px; }
    .check-img-wrap {
      flex: 1; text-align: center; cursor: pointer;
      border: 3px solid transparent; border-radius: 12px;
      padding: 12px; transition: all 0.2s; background: #f8fafc;
    }
    .check-img-wrap:hover { background: #f1f5f9; transform: translateY(-3px); }
    .check-img-wrap.selected { border-color: var(--accent); background: #eff6ff; box-shadow: 0 8px 16px rgba(37,99,235,0.15); }
    .check-img-wrap img { width: 100%; height: 300px; object-fit: contain; border-radius: 8px; background: #e2e8f0; }
    .check-label { margin-top: 12px; font-weight: 700; color: #64748b; font-size: 16px; }

    /* ÂºπÁ™ó */
    #msg-modal {
      position: fixed; inset: 0; background: rgba(15,23,42,0.6); z-index: 10001;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    #msg-modal.show { display: flex; }
    .msg-box {
      background: #fff; width: 480px; max-width: 90%; padding: 36px;
      border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      text-align: center; position: relative;
    }
    .msg-icon { font-size: 48px; margin-bottom: 16px; display: block; }
    .msg-text { font-size: 17px; color: #334155; margin-bottom: 28px; line-height: 1.6; user-select: text; white-space: pre-wrap; }
    .msg-btn {
      background: var(--accent); color: #fff; border: none; padding: 14px 32px;
      border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;
    }

    @media (max-width:768px){
      .row { grid-template-columns: 1fr; }
      .images { flex-direction: column; height: auto; }
      .images img, .regions-wrap img { width: 100%; height: auto; max-height: 400px; }
      .check-pair { flex-direction: column; }
      .check-img-wrap img { height: 220px; }
      .buttons { flex-direction: column-reverse; gap: 16px; }
      button { width: 100%; }
      .region-list-container { flex-direction: column; gap: 16px; }
    }

    /* Summary Table Style */
    .summary-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 15px; }
    .summary-table th, .summary-table td { padding: 14px; border: 1px solid #cbd5e1; text-align: center; }
    .summary-table th { background: #f1f5f9; color: #334155; font-weight: 700; }
    
    /* Submit Overlay */
    #submit-overlay { 
        position: fixed; inset: 0; background: rgba(11,17,32,0.8); z-index: 9999; 
        display: none; 
        align-items: center; justify-content: center; 
    }
    #submit-overlay.show { display: flex; }
    .card { background: #fff; padding: 36px; border-radius: 16px; width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }

    /* Submission Receipt */
    #submission-receipt {
        background: #f0fdf4; 
        border: 2px solid #bbf7d0; 
        border-radius: 12px; 
        padding: 24px; 
        text-align: center; 
        color: #14532d;
    }
    #submission-receipt h3 { color: #15803d; margin-bottom: 12px; }

  </style>
</head>

<body data-pair-ids="">

<div id="msg-modal">
  <div class="msg-box">
    <div class="msg-icon">üëã</div>
    <div class="msg-text" id="msg-content">Notification</div>
    <button class="msg-btn" onclick="document.getElementById('msg-modal').classList.remove('show')">OK, I understand</button>
  </div>
</div>

<div id="loading-overlay" style="position:fixed;inset:0;background:#fff;z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;">
  <div style="font-size:1.5rem;font-weight:700;color:#1e293b;margin-bottom:10px;">Loading Survey</div>
  <div style="width:40px;height:40px;border:5px solid rgba(37,99,235,0.2);border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite;"></div>
  <div id="loading-error" style="display:none;margin-top:20px;color:#ef4444;font-weight:600;"></div>
</div>
<style>@keyframes spin{to{transform:rotate(360deg)}}</style>

<div class="container">
    <h1>Street Perception Survey</h1>

    <div id="page-1" class="page active">
      <h2>1. Participant information</h2>
      <div class="row">
        <div>
          <label for="user-id">User ID (required)</label>
          <input id="user-id" type="text" placeholder="e.g. P001" />
        </div>
        <div>
          <label for="age">Age (required)</label>
          <input id="age" type="number" min="10" max="120" />
        </div>
        <div>
          <label for="gender">Gender (required)</label>
          <select id="gender"><option value="">Please choose...</option><option value="female">Female</option><option value="male">Male</option><option value="other">Other / Prefer not to say</option></select>
        </div>
        <div>
          <label for="nationality">Nationality (required)</label>
          <select id="nationality" required>
            <option value="">Please choose...</option>
            <option value="Afghanistan">Afghanistan</option><option value="Albania">Albania</option><option value="Algeria">Algeria</option><option value="Andorra">Andorra</option><option value="Angola">Angola</option><option value="Argentina">Argentina</option><option value="Armenia">Armenia</option><option value="Australia">Australia</option><option value="Austria">Austria</option><option value="Azerbaijan">Azerbaijan</option><option value="Bahamas">Bahamas</option><option value="Bahrain">Bahrain</option><option value="Bangladesh">Bangladesh</option><option value="Barbados">Barbados</option><option value="Belarus">Belarus</option><option value="Belgium">Belgium</option><option value="Belize">Belize</option><option value="Benin">Benin</option><option value="Bhutan">Bhutan</option><option value="Bolivia">Bolivia</option><option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option><option value="Botswana">Botswana</option><option value="Brazil">Brazil</option><option value="Brunei Darussalam">Brunei Darussalam</option><option value="Bulgaria">Bulgaria</option><option value="Burkina Faso">Burkina Faso</option><option value="Burundi">Burundi</option><option value="Cambodia">Cambodia</option><option value="Cameroon">Cameroon</option><option value="Canada">Canada</option><option value="Cape Verde">Cape Verde</option><option value="Central African Republic">Central African Republic</option><option value="Chad">Chad</option><option value="Chile">Chile</option><option value="China">China</option><option value="Colombia">Colombia</option><option value="Comoros">Comoros</option><option value="Congo">Congo</option><option value="Costa Rica">Costa Rica</option><option value="Croatia">Croatia</option><option value="Cuba">Cuba</option><option value="Cyprus">Cyprus</option><option value="Czech Republic">Czech Republic</option><option value="Denmark">Denmark</option><option value="Djibouti">Djibouti</option><option value="Dominica">Dominica</option><option value="Dominican Republic">Dominican Republic</option><option value="Ecuador">Ecuador</option><option value="Egypt">Egypt</option><option value="El Salvador">El Salvador</option><option value="Equatorial Guinea">Equatorial Guinea</option><option value="Eritrea">Eritrea</option><option value="Estonia">Estonia</option><option value="Ethiopia">Ethiopia</option><option value="Fiji">Fiji</option><option value="Finland">Finland</option><option value="France">France</option><option value="Gabon">Gabon</option><option value="Gambia">Gambia</option><option value="Georgia">Georgia</option><option value="Germany">Germany</option><option value="Ghana">Ghana</option><option value="Greece">Greece</option><option value="Grenada">Grenada</option><option value="Guatemala">Guatemala</option><option value="Guinea">Guinea</option><option value="Guyana">Guyana</option><option value="Haiti">Haiti</option><option value="Honduras">Honduras</option><option value="Hong Kong">Hong Kong</option><option value="Hungary">Hungary</option><option value="Iceland">Iceland</option><option value="India">India</option><option value="Indonesia">Indonesia</option><option value="Iran, Islamic Republic of">Iran, Islamic Republic of</option><option value="Iraq">Iraq</option><option value="Ireland">Ireland</option><option value="Israel">Israel</option><option value="Italy">Italy</option><option value="Jamaica">Jamaica</option><option value="Japan">Japan</option><option value="Jordan">Jordan</option><option value="Kazakhstan">Kazakhstan</option><option value="Kenya">Kenya</option><option value="Kiribati">Kiribati</option><option value="Korea, Republic of">Korea, Republic of</option><option value="Kuwait">Kuwait</option><option value="Kyrgyzstan">Kyrgyzstan</option><option value="Lao People's Democratic Republic">Lao People's Democratic Republic</option><option value="Latvia">Latvia</option><option value="Lebanon">Lebanon</option><option value="Lesotho">Lesotho</option><option value="Liberia">Liberia</option><option value="Libya">Libya</option><option value="Liechtenstein">Liechtenstein</option><option value="Lithuania">Lithuania</option><option value="Luxembourg">Luxembourg</option><option value="Macao">Macao</option><option value="Macedonia">Macedonia</option><option value="Madagascar">Madagascar</option><option value="Malawi">Malawi</option><option value="Malaysia">Malaysia</option><option value="Maldives">Maldives</option><option value="Mali">Mali</option><option value="Malta">Malta</option><option value="Mauritania">Mauritania</option><option value="Mauritius">Mauritius</option><option value="Mexico">Mexico</option><option value="Moldova">Moldova</option><option value="Monaco">Monaco</option><option value="Mongolia">Mongolia</option><option value="Montenegro">Montenegro</option><option value="Morocco">Morocco</option><option value="Mozambique">Mozambique</option><option value="Myanmar">Myanmar</option><option value="Namibia">Namibia</option><option value="Nepal">Nepal</option><option value="Netherlands">Netherlands</option><option value="New Zealand">New Zealand</option><option value="Nicaragua">Nicaragua</option><option value="Niger">Niger</option><option value="Nigeria">Nigeria</option><option value="Norway">Norway</option><option value="Oman">Oman</option><option value="Pakistan">Pakistan</option><option value="Palau">Palau</option><option value="Panama">Panama</option><option value="Papua New Guinea">Papua New Guinea</option><option value="Paraguay">Paraguay</option><option value="Peru">Peru</option><option value="Philippines">Philippines</option><option value="Poland">Poland</option><option value="Portugal">Portugal</option><option value="Qatar">Qatar</option><option value="Romania">Romania</option><option value="Russian Federation">Russian Federation</option><option value="Rwanda">Rwanda</option><option value="Samoa">Samoa</option><option value="Saudi Arabia">Saudi Arabia</option><option value="Senegal">Senegal</option><option value="Serbia">Serbia</option><option value="Seychelles">Seychelles</option><option value="Sierra Leone">Sierra Leone</option><option value="Singapore">Singapore</option><option value="Slovakia">Slovakia</option><option value="Slovenia">Slovenia</option><option value="Somalia">Somalia</option><option value="South Africa">South Africa</option><option value="Spain">Spain</option><option value="Sri Lanka">Sri Lanka</option><option value="Sudan">Sudan</option><option value="Suriname">Suriname</option><option value="Swaziland">Swaziland</option><option value="Sweden">Sweden</option><option value="Switzerland">Switzerland</option><option value="Syria">Syria</option><option value="Taiwan">Taiwan</option><option value="Tajikistan">Tajikistan</option><option value="Tanzania">Tanzania</option><option value="Thailand">Thailand</option><option value="Timor-Leste">Timor-Leste</option><option value="Togo">Togo</option><option value="Tonga">Tonga</option><option value="Trinidad and Tobago">Trinidad and Tobago</option><option value="Tunisia">Tunisia</option><option value="Turkey">Turkey</option><option value="Turkmenistan">Turkmenistan</option><option value="Uganda">Uganda</option><option value="Ukraine">Ukraine</option><option value="United Arab Emirates">United Arab Emirates</option><option value="United Kingdom">United Kingdom</option><option value="United States">United States</option><option value="Uruguay">Uruguay</option><option value="Uzbekistan">Uzbekistan</option><option value="Venezuela">Venezuela</option><option value="Vietnam">Vietnam</option><option value="Yemen">Yemen</option><option value="Zambia">Zambia</option><option value="Zimbabwe">Zimbabwe</option><option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label for="education">Education level (highest completed degree)</label>
          <select id="education"><option value="">(optional)</option><option value="highschool">High school or lower</option><option value="bachelor">Bachelor</option><option value="master">Master</option><option value="phd">PhD</option></select>
        </div>
      </div>
      <div class="buttons"><div></div><button id="to-page-2" data-next="2" type="button">Next: Safe ‚Äî Rating ‚ñ∂</button></div>
    </div>

    <div id="page-2" class="page" data-attr-index="0">
      <h2>2. Safe ‚Äî Pairwise comparison</h2>
      <div class="definition-box"><strong>Safe:</strong> Looks safe, secure, and not threatening.</div>
      <div class="images">
        <div class="img-wrapper"><img class="survey-img-1" src=""></div>
        <div class="img-wrapper"><img class="survey-img-2" src=""></div>
      </div>
      <div class="rating-list" id="rating-Safe"></div>
      <div class="buttons"><button class="secondary" data-go="1" type="button">‚óÄ Back</button><button data-next="3" type="button">Next: mark Safe points ‚ñ∂</button></div>
    </div>

    <div id="page-3" class="page" data-attr-index="0">
      <h2>3. Safe ‚Äî Circle regions</h2>
      <div class="definition-box"><strong>Safe:</strong> Looks safe, secure, and not threatening.</div>
      <div class="circling-header">
        <div>Draw circles around distinct objects (e.g., a specific tree).</div>
        <div class="legend"><span style="color:var(--pos)"><span class="dot" style="background:var(--pos)"></span>Positive</span> <span style="color:var(--neg)"><span class="dot" style="background:var(--neg)"></span>Negative</span></div>
      </div>
      <div class="images">
        <div class="regions-wrap"><img id="img-Safe-1" class="survey-img-1" src="" /><canvas id="cvs-Safe-1"></canvas></div>
        <div class="regions-wrap"><img id="img-Safe-2" class="survey-img-2" src="" /><canvas id="cvs-Safe-2"></canvas></div>
      </div>
      
      <div class="controls-toolbar">
        <button class="small secondary" data-undo type="button">‚ü≤ Undo last action</button>
        <button class="small secondary" data-clear type="button">Clear All</button>
        <div style="width:1px; background:#cbd5e1; margin:0 12px;"></div>
        <button class="small btn-toggle" data-toggle-sentiment type="button" disabled>Toggle (+/-)</button>
        <button class="small btn-delete" data-delete-selected type="button" disabled>Delete Selected</button>
      </div>

      <div class="region-list-container">
        <div class="region-col">
          <h4>Image 1 Regions</h4>
          <div class="region-items" id="list-Safe-1"></div>
        </div>
        <div class="region-col">
          <h4>Image 2 Regions</h4>
          <div class="region-items" id="list-Safe-2"></div>
        </div>
      </div>

      <div class="global-factor-section">
        <h3>Is there a global atmospheric factor influencing your choice?</h3>
        <p>(If you have circled specific elements above, you may skip this. Otherwise, please select at least one.)</p>
        <div class="checkbox-group" id="global-Safe">
            <label class="checkbox-item"><input type="checkbox" value="Lighting"> Lighting / Brightness</label>
            <label class="checkbox-item"><input type="checkbox" value="Weather"> Weather / Sky</label>
            <label class="checkbox-item"><input type="checkbox" value="Layout"> Overall Layout / Openness</label>
            <label class="checkbox-item"><input type="checkbox" value="None"> No specific reason</label>
        </div>
      </div>

      <div class="buttons"><button class="secondary" data-back-to-rating type="button">‚óÄ Back to rating</button><button data-next="4" type="button">Next: Lively ‚Äî Rating ‚ñ∂</button></div>
    </div>

    <div id="page-4" class="page" data-attr-index="1">
      <h2>4. Lively ‚Äî Pairwise comparison</h2>
      <div class="definition-box"><strong>Lively:</strong> Bustling with activities, energetic, and vibrant.</div>
      <div class="images"><div class="img-wrapper"><img class="survey-img-1" src=""></div><div class="img-wrapper"><img class="survey-img-2" src=""></div></div>
      <div class="rating-list" id="rating-Lively"></div>
      <div class="buttons"><button class="secondary" data-go="3" type="button">‚óÄ Back</button><button data-next="5" type="button">Next: mark Lively points ‚ñ∂</button></div>
    </div>

    <div id="page-5" class="page" data-attr-index="1">
      <h2>5. Lively ‚Äî Circle regions</h2>
      <div class="definition-box"><strong>Lively:</strong> Bustling with activities, energetic, and vibrant.</div>
      <div class="circling-header">
        <div>Draw circles around distinct objects (e.g., people, shops).</div>
        <div class="legend"><span style="color:var(--pos)"><span class="dot" style="background:var(--pos)"></span>Positive</span> <span style="color:var(--neg)"><span class="dot" style="background:var(--neg)"></span>Negative</span></div>
      </div>
      <div class="images">
        <div class="regions-wrap"><img id="img-Lively-1" class="survey-img-1" src="" /><canvas id="cvs-Lively-1"></canvas></div>
        <div class="regions-wrap"><img id="img-Lively-2" class="survey-img-2" src="" /><canvas id="cvs-Lively-2"></canvas></div>
      </div>
      <div class="controls-toolbar">
        <button class="small secondary" data-undo type="button">‚ü≤ Undo last action</button><button class="small secondary" data-clear type="button">Clear All</button>
        <div style="width:1px; background:#cbd5e1; margin:0 12px;"></div>
        <button class="small btn-toggle" data-toggle-sentiment type="button" disabled>Toggle (+/-)</button><button class="small btn-delete" data-delete-selected type="button" disabled>Delete Selected</button>
      </div>
      <div class="region-list-container">
        <div class="region-col"><h4>Image 1 Regions</h4><div class="region-items" id="list-Lively-1"></div></div>
        <div class="region-col"><h4>Image 2 Regions</h4><div class="region-items" id="list-Lively-2"></div></div>
      </div>
      <div class="global-factor-section">
        <h3>Is there a global atmospheric factor influencing your choice?</h3>
        <p>(If you have circled specific elements above, you may skip this. Otherwise, please select at least one.)</p>
        <div class="checkbox-group" id="global-Lively">
            <label class="checkbox-item"><input type="checkbox" value="Lighting"> Lighting / Brightness</label><label class="checkbox-item"><input type="checkbox" value="Weather"> Weather / Sky</label><label class="checkbox-item"><input type="checkbox" value="Layout"> Overall Layout / Openness</label><label class="checkbox-item"><input type="checkbox" value="None"> No specific reason</label>
        </div>
      </div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">‚óÄ Back to rating</button><button data-next="6" type="button">Next: Beautiful ‚Äî Rating ‚ñ∂</button></div>
    </div>

    <div id="page-6" class="page" data-attr-index="2">
      <h2>6. Beautiful ‚Äî Pairwise comparison</h2>
      <div class="definition-box"><strong>Beautiful:</strong> Aesthetically pleasing and nice to look at.</div>
      <div class="images"><div class="img-wrapper"><img class="survey-img-1" src=""></div><div class="img-wrapper"><img class="survey-img-2" src=""></div></div>
      <div class="rating-list" id="rating-Beautiful"></div>
      <div class="buttons"><button class="secondary" data-go="5" type="button">‚óÄ Back</button><button data-next="7" type="button">Next: mark Beautiful points ‚ñ∂</button></div>
    </div>

    <div id="page-7" class="page" data-attr-index="2">
      <h2>7. Beautiful ‚Äî Circle regions</h2>
      <div class="definition-box"><strong>Beautiful:</strong> Aesthetically pleasing and nice to look at.</div>
      <div class="circling-header">
        <div>Draw circles around distinct objects (e.g., flowers, architecture).</div>
        <div class="legend"><span style="color:var(--pos)"><span class="dot" style="background:var(--pos)"></span>Positive</span> <span style="color:var(--neg)"><span class="dot" style="background:var(--neg)"></span>Negative</span></div>
      </div>
      <div class="images">
        <div class="regions-wrap"><img id="img-Beautiful-1" class="survey-img-1" src="" /><canvas id="cvs-Beautiful-1"></canvas></div>
        <div class="regions-wrap"><img id="img-Beautiful-2" class="survey-img-2" src="" /><canvas id="cvs-Beautiful-2"></canvas></div>
      </div>
      <div class="controls-toolbar">
        <button class="small secondary" data-undo type="button">‚ü≤ Undo last action</button><button class="small secondary" data-clear type="button">Clear All</button>
        <div style="width:1px; background:#cbd5e1; margin:0 12px;"></div>
        <button class="small btn-toggle" data-toggle-sentiment type="button" disabled>Toggle (+/-)</button><button class="small btn-delete" data-delete-selected type="button" disabled>Delete Selected</button>
      </div>
      <div class="region-list-container">
        <div class="region-col"><h4>Image 1 Regions</h4><div class="region-items" id="list-Beautiful-1"></div></div>
        <div class="region-col"><h4>Image 2 Regions</h4><div class="region-items" id="list-Beautiful-2"></div></div>
      </div>
      <div class="global-factor-section">
        <h3>Is there a global atmospheric factor influencing your choice?</h3>
        <p>(If you have circled specific elements above, you may skip this. Otherwise, please select at least one.)</p>
        <div class="checkbox-group" id="global-Beautiful">
            <label class="checkbox-item"><input type="checkbox" value="Lighting"> Lighting / Brightness</label><label class="checkbox-item"><input type="checkbox" value="Weather"> Weather / Sky</label><label class="checkbox-item"><input type="checkbox" value="Layout"> Overall Layout / Openness</label><label class="checkbox-item"><input type="checkbox" value="None"> No specific reason</label>
        </div>
      </div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">‚óÄ Back to rating</button><button data-next="check" type="button">Next: Environment Classification ‚ñ∂</button></div>
    </div>

    <div id="page-check" class="page">
      <h2>8. Environment Classification</h2>
      <p style="margin-bottom:20px; color:var(--muted)">To help us better understand your preferences, please answer the following questions.</p>
      
      <div class="check-section">
        <h3 style="margin-top:0;">1. In each row below, please click on the image that best represents a <strong>Rural</strong> (countryside) environment.</h3>
        
        <div class="check-row" id="qc-row-1">
          <div style="width:30px;font-weight:700;padding-top:12px;">1.</div>
          <div class="check-pair">
            <div class="check-img-wrap" onclick="selectQC('1','A')"><img id="qc-img-1-A" src=""><div class="check-label">Image A</div></div>
            <div class="check-img-wrap" onclick="selectQC('1','B')"><img id="qc-img-1-B" src=""><div class="check-label">Image B</div></div>
          </div>
          <input type="hidden" id="qc-ans-1" value="">
        </div>

        <div class="check-row" id="qc-row-2">
            <div style="width:30px;font-weight:700;padding-top:12px;">2.</div>
            <div class="check-pair">
              <div class="check-img-wrap" onclick="selectQC('2','A')"><img id="qc-img-2-A" src=""><div class="check-label">Image A</div></div>
              <div class="check-img-wrap" onclick="selectQC('2','B')"><img id="qc-img-2-B" src=""><div class="check-label">Image B</div></div>
            </div>
            <input type="hidden" id="qc-ans-2" value="">
        </div>

        <div class="check-row" id="qc-row-3">
            <div style="width:30px;font-weight:700;padding-top:12px;">3.</div>
            <div class="check-pair">
              <div class="check-img-wrap" onclick="selectQC('3','A')"><img id="qc-img-3-A" src=""><div class="check-label">Image A</div></div>
              <div class="check-img-wrap" onclick="selectQC('3','B')"><img id="qc-img-3-B" src=""><div class="check-label">Image B</div></div>
            </div>
            <input type="hidden" id="qc-ans-3" value="">
        </div>
      </div>

      <div class="check-section">
        <h3 style="margin-top:0;">2. General Preference</h3>
        <p style="font-size:16px; margin-bottom:16px;">In general, which type of environment do you prefer living in?</p>
        <div style="display:flex; flex-direction:column; gap:12px;">
           <label class="rating-option">
               <input type="radio" name="preference" value="urban"> <span style="font-weight:400">I prefer Urban (City)</span>
           </label>
           <label class="rating-option">
               <input type="radio" name="preference" value="rural"> <span style="font-weight:400">I prefer Rural (Countryside)</span>
           </label>
           <label class="rating-option">
               <input type="radio" name="preference" value="neutral"> <span style="font-weight:400">No preference / Neutral</span>
           </label>
        </div>
      </div>

      <div class="buttons">
        <button class="secondary" data-go="7" type="button">‚óÄ Back</button>
        <button id="btn-check-next" data-next="9" type="button">Next: Wealthy ‚Äî Rating ‚ñ∂</button>
      </div>
    </div>

    <div id="page-9" class="page" data-attr-index="3">
      <h2>9. Wealthy ‚Äî Pairwise comparison</h2>
      <div class="definition-box"><strong>Wealthy:</strong> Affluent, high-status, and expensive neighborhood.</div>
      <div class="images"><div class="img-wrapper"><img class="survey-img-1" src=""></div><div class="img-wrapper"><img class="survey-img-2" src=""></div></div>
      <div class="rating-list" id="rating-Wealthy"></div>
      <div class="buttons"><button class="secondary" data-go="check" type="button">‚óÄ Back</button><button data-next="10" type="button">Next: mark Wealthy points ‚ñ∂</button></div>
    </div>

    <div id="page-10" class="page" data-attr-index="3">
      <h2>10. Wealthy ‚Äî Circle regions</h2>
      <div class="definition-box"><strong>Wealthy:</strong> Affluent, high-status, and expensive neighborhood.</div>
      <div class="circling-header">
        <div>Draw circles around distinct objects (e.g., luxury cars, nice facades).</div>
        <div class="legend"><span style="color:var(--pos)"><span class="dot" style="background:var(--pos)"></span>Positive</span> <span style="color:var(--neg)"><span class="dot" style="background:var(--neg)"></span>Negative</span></div>
      </div>
      <div class="images">
        <div class="regions-wrap"><img id="img-Wealthy-1" class="survey-img-1" src="" /><canvas id="cvs-Wealthy-1"></canvas></div>
        <div class="regions-wrap"><img id="img-Wealthy-2" class="survey-img-2" src="" /><canvas id="cvs-Wealthy-2"></canvas></div>
      </div>
      <div class="controls-toolbar">
        <button class="small secondary" data-undo type="button">‚ü≤ Undo last action</button><button class="small secondary" data-clear type="button">Clear All</button>
        <div style="width:1px; background:#cbd5e1; margin:0 12px;"></div>
        <button class="small btn-toggle" data-toggle-sentiment type="button" disabled>Toggle (+/-)</button><button class="small btn-delete" data-delete-selected type="button" disabled>Delete Selected</button>
      </div>
      <div class="region-list-container">
        <div class="region-col"><h4>Image 1 Regions</h4><div class="region-items" id="list-Wealthy-1"></div></div>
        <div class="region-col"><h4>Image 2 Regions</h4><div class="region-items" id="list-Wealthy-2"></div></div>
      </div>
      <div class="global-factor-section">
        <h3>Is there a global atmospheric factor influencing your choice?</h3>
        <p>(If you have circled specific elements above, you may skip this. Otherwise, please select at least one.)</p>
        <div class="checkbox-group" id="global-Wealthy">
            <label class="checkbox-item"><input type="checkbox" value="Lighting"> Lighting / Brightness</label><label class="checkbox-item"><input type="checkbox" value="Weather"> Weather / Sky</label><label class="checkbox-item"><input type="checkbox" value="Layout"> Overall Layout / Openness</label><label class="checkbox-item"><input type="checkbox" value="None"> No specific reason</label>
        </div>
      </div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">‚óÄ Back to rating</button><button data-next="11" type="button">Next: Boring ‚Äî Rating ‚ñ∂</button></div>
    </div>

    <div id="page-11" class="page" data-attr-index="4">
      <h2>11. Boring ‚Äî Pairwise comparison</h2>
      <div class="definition-box"><strong>Boring:</strong> Dull, uninteresting, and monotonous.</div>
      <div class="images"><div class="img-wrapper"><img class="survey-img-1" src=""></div><div class="img-wrapper"><img class="survey-img-2" src=""></div></div>
      <div class="rating-list" id="rating-Boring"></div>
      <div class="buttons"><button class="secondary" data-go="10" type="button">‚óÄ Back</button><button data-next="12" type="button">Next: mark Boring points ‚ñ∂</button></div>
    </div>

    <div id="page-12" class="page" data-attr-index="4">
      <h2>12. Boring ‚Äî Circle regions</h2>
      <div class="definition-box"><strong>Boring:</strong> Dull, uninteresting, and monotonous.</div>
      <div class="circling-header">
        <div>Draw circles around distinct objects (e.g., grey walls, empty streets).</div>
        <div class="legend"><span style="color:var(--pos)"><span class="dot" style="background:var(--pos)"></span>Positive</span> <span style="color:var(--neg)"><span class="dot" style="background:var(--neg)"></span>Negative</span></div>
      </div>
      <div class="images">
        <div class="regions-wrap"><img id="img-Boring-1" class="survey-img-1" src="" /><canvas id="cvs-Boring-1"></canvas></div>
        <div class="regions-wrap"><img id="img-Boring-2" class="survey-img-2" src="" /><canvas id="cvs-Boring-2"></canvas></div>
      </div>
      <div class="controls-toolbar">
        <button class="small secondary" data-undo type="button">‚ü≤ Undo last action</button><button class="small secondary" data-clear type="button">Clear All</button>
        <div style="width:1px; background:#cbd5e1; margin:0 12px;"></div>
        <button class="small btn-toggle" data-toggle-sentiment type="button" disabled>Toggle (+/-)</button><button class="small btn-delete" data-delete-selected type="button" disabled>Delete Selected</button>
      </div>
      <div class="region-list-container">
        <div class="region-col"><h4>Image 1 Regions</h4><div class="region-items" id="list-Boring-1"></div></div>
        <div class="region-col"><h4>Image 2 Regions</h4><div class="region-items" id="list-Boring-2"></div></div>
      </div>
      <div class="global-factor-section">
        <h3>Is there a global atmospheric factor influencing your choice?</h3>
        <p>(If you have circled specific elements above, you may skip this. Otherwise, please select at least one.)</p>
        <div class="checkbox-group" id="global-Boring">
            <label class="checkbox-item"><input type="checkbox" value="Lighting"> Lighting / Brightness</label><label class="checkbox-item"><input type="checkbox" value="Weather"> Weather / Sky</label><label class="checkbox-item"><input type="checkbox" value="Layout"> Overall Layout / Openness</label><label class="checkbox-item"><input type="checkbox" value="None"> No specific reason</label>
        </div>
      </div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">‚óÄ Back to rating</button><button data-next="13" type="button">Next: Depressing ‚Äî Rating ‚ñ∂</button></div>
    </div>

    <div id="page-13" class="page" data-attr-index="5">
      <h2>13. Depressing ‚Äî Pairwise comparison</h2>
      <div class="definition-box"><strong>Depressing:</strong> Grim, bleak, and evoking sadness.</div>
      <div class="images"><div class="img-wrapper"><img class="survey-img-1" src=""></div><div class="img-wrapper"><img class="survey-img-2" src=""></div></div>
      <div class="rating-list" id="rating-Depressing"></div>
      <div class="buttons"><button class="secondary" data-go="12" type="button">‚óÄ Back</button><button data-next="14" type="button">Next: mark Depressing points ‚ñ∂</button></div>
    </div>

    <div id="page-14" class="page" data-attr-index="5">
      <h2>14. Depressing ‚Äî Circle regions</h2>
      <div class="definition-box"><strong>Depressing:</strong> Grim, bleak, and evoking sadness.</div>
      <div class="circling-header">
        <div>Draw circles around distinct objects (e.g., trash, ruined buildings).</div>
        <div class="legend"><span style="color:var(--pos)"><span class="dot" style="background:var(--pos)"></span>Positive</span> <span style="color:var(--neg)"><span class="dot" style="background:var(--neg)"></span>Negative</span></div>
      </div>
      <div class="images">
        <div class="regions-wrap"><img id="img-Depressing-1" class="survey-img-1" src="" /><canvas id="cvs-Depressing-1"></canvas></div>
        <div class="regions-wrap"><img id="img-Depressing-2" class="survey-img-2" src="" /><canvas id="cvs-Depressing-2"></canvas></div>
      </div>
      <div class="controls-toolbar">
        <button class="small secondary" data-undo type="button">‚ü≤ Undo last action</button><button class="small secondary" data-clear type="button">Clear All</button>
        <div style="width:1px; background:#cbd5e1; margin:0 12px;"></div>
        <button class="small btn-toggle" data-toggle-sentiment type="button" disabled>Toggle (+/-)</button><button class="small btn-delete" data-delete-selected type="button" disabled>Delete Selected</button>
      </div>
      <div class="region-list-container">
        <div class="region-col"><h4>Image 1 Regions</h4><div class="region-items" id="list-Depressing-1"></div></div>
        <div class="region-col"><h4>Image 2 Regions</h4><div class="region-items" id="list-Depressing-2"></div></div>
      </div>
      <div class="global-factor-section">
        <h3>Is there a global atmospheric factor influencing your choice?</h3>
        <p>(If you have circled specific elements above, you may skip this. Otherwise, please select at least one.)</p>
        <div class="checkbox-group" id="global-Depressing">
            <label class="checkbox-item"><input type="checkbox" value="Lighting"> Lighting / Brightness</label><label class="checkbox-item"><input type="checkbox" value="Weather"> Weather / Sky</label><label class="checkbox-item"><input type="checkbox" value="Layout"> Overall Layout / Openness</label><label class="checkbox-item"><input type="checkbox" value="None"> No specific reason</label>
        </div>
      </div>
      <div class="buttons"><button class="secondary" data-back-to-rating type="button">‚óÄ Back to rating</button><button data-next="15" type="button">Next: Review & Submit ‚ñ∂</button></div>
    </div>

    <div id="page-15" class="page">
      <h2>15. Review & Submit</h2>
      <p style="margin-bottom:20px; font-size:16px;">Please review your responses before submitting.</p>
      
      <div id="summary-container"></div>
      
      <div class="buttons">
        <button class="secondary" data-go="14" type="button">‚óÄ Back</button>
        <div>
          <button id="finish" type="button">Finish and export ‚ñ∂</button>
        </div>
      </div>
      
      <div id="submission-receipt" style="display:none; margin-top:30px;">
         <h3>Submission Successful</h3>
         <div style="font-size:14px; margin-bottom:8px;">Thank you for your participation!</div>
         <div id="receipt-content" style="font-family:monospace; color:#334155;"></div>
      </div>
    </div>

</div>

<div id="submit-overlay">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:center;">
        <div class="title" style="font-weight:700;font-size:18px;margin-bottom:8px;">Submitting‚Ä¶</div>
        <div class="spinner" style="margin-left:12px;"></div>
      </div>
      <div class="message" id="submit-overlay-message" style="margin-bottom:16px;">Please wait...</div>
      <div class="status-small" id="submit-overlay-status" style="font-size:13px; color:#64748b;"></div>
      <button id="submit-overlay-confirm" style="margin-top:16px;display:none;background:#22c55e;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">OK</button>
    </div>
</div>
<script>
(function() {
    'use strict';

    // *** ÈÖçÁΩÆÂ∏∏Èáè ***
    // ËØ∑Á°Æ‰øùÊ≠§ URL ÊòØÊÇ®ÊúÄÊñ∞ÈÉ®ÁΩ≤ÁöÑ Web App URL
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw7McAU8hFgo3MYWxcUL8AmKsK0CV1oGaHfa_zyh-q9_axwbZxUDIqc31-jirULc-4R/exec';
    const ATTRIBUTES = ['Safe', 'Lively', 'Beautiful', 'Wealthy', 'Boring', 'Depressing'];
    
    // È¢úËâ≤ÈÖçÁΩÆ
    const COLORS = {
        pos: { stroke: '#22c55e', fill: 'rgba(34, 197, 94, 0.2)' }, 
        neg: { stroke: '#ef4444', fill: 'rgba(239, 68, 68, 0.2)' }
    };

    // *** ÂÖ®Â±ÄÁä∂ÊÄÅ ***
    var state = { 
        demographics: {}, 
        pairwise: {}, 
        points: {}, 
        global_factors: {}, 
        quality_check: {} 
    };

    // ÂàùÂßãÂåñÊï∞ÊçÆÁªìÊûÑ
    ATTRIBUTES.forEach(a => {
        state.points[a] = { '1.jpg': [], '2.jpg': [] };
        state.global_factors[a] = [];
    });

    var assignedPairInfo = null;
    var fabricCanvases = {};  // Â≠òÂÇ® Canvas ÂÆû‰æã
    
    // --- Êí§ÈîÄÁ≥ªÁªü (Undo System) ---
    var canvasHistory = {};   // { 'Safe-1': [json1, json2...] }
    var pageActionStack = []; // ['Safe-1', 'Safe-2'...] ËÆ∞ÂΩïÊìç‰ΩúÈ°∫Â∫è
    var isRestoring = false; 

    // --- Áªü‰∏ÄÊ∂àÊÅØÊèêÁ§∫Ê°Ü ---
    function showDialog(title, text) {
        var modal = document.getElementById('msg-modal');
        var content = document.getElementById('msg-content');
        var icon = 'üëã';
        if(title.includes('Missing') || title.includes('Required')) icon = 'üìù';
        if(title.includes('Logic')) icon = 'üí°';
        if(title.includes('Error')) icon = '‚ö†Ô∏è';

        modal.querySelector('.msg-icon').textContent = icon;
        var html = `<strong>${title}</strong>\n\n${text}`;
        content.innerHTML = html.replace(/\n/g, '<br/>');
        modal.classList.add('show');
    }

    // --- Âü∫Á°ÄÂ∑•ÂÖ∑ ---
    function q(s) { return document.querySelector(s); }
    function qa(s) { return Array.from(document.querySelectorAll(s)); }
    function getQueryParam(n) { try { return new URL(window.location.href).searchParams.get(n); } catch (e) { return null; } }
    
    function getProlificPid() {
        var p = getQueryParam('PROLIFIC_PID') || getQueryParam('PROLIFICID') || getQueryParam('participant_id') || getQueryParam('worker_id');
        if (p) return p.trim();
        var s = localStorage.getItem('anon_worker_id');
        if (!s) { s = 'anon-' + Math.random().toString(36).slice(2); localStorage.setItem('anon_worker_id', s); }
        return s;
    }

    function getFastDriveUrl(fileId) {
        // ‰ΩøÁî® Google ÂÆòÊñπÁöÑÈ´òÈÄüÁº©Áï•Âõæ/ÂÜÖÂÆπÊé•Âè£ÔºåÊØî drive.google.com/uc?id=... Âø´ÂæàÂ§ö
        return 'https://lh3.googleusercontent.com/d/' + fileId;
    }

    // JSONP (Ëß£ÂÜ≥Ë∑®Âüü GET ËØ∑Ê±Ç)
    function jsonp(url, callback) {
        var cbName = 'cb_' + Math.random().toString(36).slice(2);
        window[cbName] = function(data) {
            delete window[cbName];
            var el = document.getElementById('sc-' + cbName);
            if(el) el.remove();
            callback(data);
        };
        var s = document.createElement('script');
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
        s.id = 'sc-' + cbName;
        s.onerror = function() { callback({ error: 'Network error. Please check your connection.' }); };
        document.body.appendChild(s);
    }

    // --- ÂàùÂßãÂåñÊµÅÁ®ã ---
    function requestAssignment() {
        var workerId = getProlificPid();
        var url = APPS_SCRIPT_URL + '?action=assign&worker_id=' + encodeURIComponent(workerId);
        
        jsonp(url, function(data) {
            if (data && (data.pair_id || data.file_id1)) {
                assignedPairInfo = data;
                applyImages(data.file_id1, data.file_id2);
                
                // È¢ÑÂä†ËΩΩ Page 8 ÁöÑ QC ÂõæÁâá (Â¶ÇÊûúÂêéÁ´ØËøîÂõû‰∫Ü ID)
                // ËøôÊ∂àÈô§‰∫ÜÁøªÈ°µÊó∂ÁöÑÂä†ËΩΩÂª∂Ëøü
                if (data.check_images) {
                    var ci = data.check_images;
                    if(ci.rural1) q('#qc-img-1-A').src = getFastDriveUrl(ci.rural1);
                    if(ci.urban1) q('#qc-img-1-B').src = getFastDriveUrl(ci.urban1);

                    if(ci.urban2) q('#qc-img-2-A').src = getFastDriveUrl(ci.urban2);
                    if(ci.rural2) q('#qc-img-2-B').src = getFastDriveUrl(ci.rural2);

                    if(ci.urban3) q('#qc-img-3-A').src = getFastDriveUrl(ci.urban3);
                    if(ci.rural3) q('#qc-img-3-B').src = getFastDriveUrl(ci.rural3);
                }
            } else {
                q('#loading-error').style.display = 'block';
                q('#loading-error').textContent = "Server Error: " + (data.error || 'No tasks available.');
            }
        });
    }

    function applyImages(fid1, fid2) {
        if (!fid1 || !fid2) return;
        var url1 = getFastDriveUrl(fid1);
        var url2 = getFastDriveUrl(fid2);
        
        qa('.survey-img-1').forEach(img => img.src = url1);
        qa('.survey-img-2').forEach(img => img.src = url2);

        var count = 0;
        function checkDone() {
            count++;
            if (count >= 2) q('#loading-overlay').style.display = 'none';
        }
        // È¢ÑÂä†ËΩΩ‰∏§Âº†‰∏ªÂõæÔºåÁ°Æ‰øùÊòæÁ§∫Êó∂Â∑≤Â∞±Áª™
        var i1 = new Image(); i1.onload = checkDone; i1.onerror = checkDone; i1.src = url1;
        var i2 = new Image(); i2.onload = checkDone; i2.onerror = checkDone; i2.src = url2;
        
        document.body.dataset.pairIds = assignedPairInfo.pair_id || ('pair_' + fid1.slice(-5));
    }

    // --- ËØÑÂàÜ UI ---
    function buildRatingControls() {
        const options = [
            { val: 1, label: "Left is much better" },
            { val: 0.5, label: "Left is slightly better" },
            { val: 0, label: "Equal / Hard to tell" },
            { val: -0.5, label: "Right is slightly better" },
            { val: -1, label: "Right is much better" }
        ];

        ATTRIBUTES.forEach(attr => {
            var container = document.getElementById('rating-' + attr);
            if (!container) return;
            container.innerHTML = '';
            
            options.forEach(opt => {
                var label = document.createElement('label');
                label.className = 'rating-option';
                var txt = opt.label;
                if(opt.val !== 0) txt += ` (${attr})`;
                label.innerHTML = `<input type="radio" name="${attr}" value="${opt.val}"><span>${txt}</span>`;
                
                label.addEventListener('change', function() {
                    container.querySelectorAll('.rating-option').forEach(o => o.classList.remove('selected'));
                    if(this.querySelector('input').checked) {
                        this.classList.add('selected');
                        state.pairwise[attr] = opt.val;
                    }
                });
                container.appendChild(label);
            });
        });
    }

    // --- Fabric.js Ê†∏ÂøÉÈÄªËæë ---

    function initFabricCanvasForPage(attr) {
        pageActionStack = []; 

        ['1', '2'].forEach(idx => {
            var key = `${attr}-${idx}`;
            var canvasId = `cvs-${attr}-${idx}`;
            var canvasEl = document.getElementById(canvasId);
            var imgEl = document.getElementById(`img-${attr}-${idx}`); // Wrapper
            
            if (!canvasEl || !imgEl) return;
            
            // Á°Æ‰øùÂ∞∫ÂØ∏ÂåπÈÖç (Wrapper È´òÂ∫¶Áî± CSS ÊéßÂà∂ÔºåCanvas ÈúÄË∑üÈöè)
            var w = imgEl.clientWidth;
            var h = imgEl.clientHeight;
            
            if (fabricCanvases[key]) {
                fabricCanvases[key].setDimensions({ width: w, height: h });
                fabricCanvases[key].calcOffset();
                return;
            }
            
            canvasHistory[key] = [];

            var canvas = new fabric.Canvas(canvasId, { 
                isDrawingMode: true, 
                width: w, 
                height: h 
            });
            
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.width = 3;
            canvas.freeDrawingBrush.color = COLORS.pos.stroke;

            fabricCanvases[key] = canvas;
            saveHistory(key);

            // *** Êô∫ËÉΩÊ®°ÂºèÂàáÊç¢ (Smart Mode Switching) ***
            // Ëß£ÂÜ≥ "ÁîªÁ¨îÊ®°Âºè‰∏ãÊó†Ê≥ïÁÇπÂáª/ÈÄâ‰∏≠Â∑≤ÁîªÂúà" ÁöÑÈóÆÈ¢ò
            canvas.on('mouse:move', function(opt) {
                var pointer = canvas.getPointer(opt.e);
                var isHoveringObject = false;
                
                var objects = canvas.getObjects();
                for (var i = objects.length - 1; i >= 0; i--) {
                    if (objects[i].containsPoint(pointer)) {
                        isHoveringObject = true;
                        break;
                    }
                }

                if (!canvas.getActiveObject()) {
                    if (isHoveringObject) {
                        if (canvas.isDrawingMode) canvas.isDrawingMode = false; // ÂÖÅËÆ∏ÁÇπÂáª
                    } else {
                        if (!canvas.isDrawingMode) canvas.isDrawingMode = true; // ÂÖÅËÆ∏ÁîªÁîª
                    }
                }
            });

            // ÁªòÂà∂ÂÆåÊàê‰∫ã‰ª∂
            canvas.on('path:created', function(e) {
                var path = e.path;
                if (path.width < 5 && path.height < 5) { canvas.remove(path); return; }

                var rawPoints = extractPointsFromPath(path);
                var polyObj = new fabric.Polygon(rawPoints, {
                    fill: COLORS.pos.fill,
                    stroke: COLORS.pos.stroke,
                    strokeWidth: 3,
                    selectable: true,
                    perPixelTargetFind: true, // Á°Æ‰øùÁÇπÂáªÂÜÖÈÉ®‰πüËÉΩÈÄâ‰∏≠
                    objectCaching: false,
                    hasControls: false,
                    hasBorders: true
                });
                
                polyObj.sentiment = 'positive'; 

                canvas.remove(path);
                canvas.add(polyObj);
                canvas.setActiveObject(polyObj);
                
                deselectOtherCanvases(key); // ‰∫íÊñ•
                pushPageAction(key); 
                saveHistory(key);
                updateUIState();
            });

            // ‰∫ã‰ª∂ÁªëÂÆö
            canvas.on('selection:created', () => { deselectOtherCanvases(key); updateUIState(); });
            canvas.on('selection:updated', updateUIState);
            canvas.on('selection:cleared', updateUIState);
            canvas.on('object:modified', () => { pushPageAction(key); saveHistory(key); });
            canvas.on('mouse:down', (opt) => {
                if(!opt.target) {
                    canvas.discardActiveObject();
                    canvas.requestRenderAll();
                    updateUIState();
                }
            });
        });
    }

    function deselectOtherCanvases(activeKey) {
        Object.keys(fabricCanvases).forEach(k => {
            if (k !== activeKey && fabricCanvases[k]) {
                fabricCanvases[k].discardActiveObject();
                fabricCanvases[k].requestRenderAll();
            }
        });
    }

    function pushPageAction(canvasKey) {
        pageActionStack.push(canvasKey);
    }

    function saveHistory(key) {
        if(isRestoring) return;
        var canvas = fabricCanvases[key];
        if(!canvas) return;
        var json = JSON.stringify(canvas.toDatalessJSON(['sentiment']));
        canvasHistory[key].push(json);
        if(canvasHistory[key].length > 30) canvasHistory[key].shift();
        renderRegionList(key);
    }

    function performGlobalUndo() {
        if (pageActionStack.length === 0) return; 
        var lastModifiedKey = pageActionStack.pop(); 
        var stack = canvasHistory[lastModifiedKey];
        var canvas = fabricCanvases[lastModifiedKey];

        if (stack && stack.length > 1 && canvas) {
            stack.pop(); 
            var prevState = stack[stack.length - 1]; 
            isRestoring = true;
            canvas.loadFromJSON(prevState, function() {
                canvas.renderAll();
                isRestoring = false;
                renderRegionList(lastModifiedKey);
                updateUIState();
            });
        }
    }

    function renderRegionList(key) {
        var parts = key.split('-');
        var listContainer = document.getElementById(`list-${parts[0]}-${parts[1]}`);
        if(!listContainer) return;
        
        var canvas = fabricCanvases[key];
        var objects = canvas.getObjects();
        
        listContainer.innerHTML = '';
        if (objects.length === 0) {
            listContainer.innerHTML = '<div style="color:#94a3b8;font-style:italic;padding:4px;font-size:13px;">No regions drawn yet</div>';
            return;
        }

        objects.forEach((obj, i) => {
            var item = document.createElement('div');
            var isPos = (obj.sentiment !== 'negative');
            item.className = `region-item ${isPos ? 'pos' : 'neg'}`;
            
            if (canvas.getActiveObjects().indexOf(obj) > -1) item.classList.add('active');
            
            item.innerHTML = `<span>Region ${i + 1}</span> <span style="font-size:12px;color:#64748b">${isPos?'Positive':'Negative'}</span>`;
            
            item.addEventListener('click', (e) => {
                e.stopPropagation(); 
                deselectOtherCanvases(key);
                canvas.discardActiveObject();
                canvas.setActiveObject(obj);
                canvas.requestRenderAll();
                updateUIState();
            });
            listContainer.appendChild(item);
        });
    }

    function getGlobalActiveObject() {
        var keys = Object.keys(fabricCanvases);
        for(var i=0; i<keys.length; i++) {
            var c = fabricCanvases[keys[i]];
            var act = c.getActiveObject();
            if(act) return { canvas: c, object: act, key: keys[i] };
        }
        return null;
    }

    function updateUIState() {
        var curPage = document.querySelector('.page.active');
        if (!curPage || !curPage.dataset.attrIndex || !curPage.querySelector('canvas')) return;

        var attr = ATTRIBUTES[parseInt(curPage.dataset.attrIndex)];
        var activeInfo = getGlobalActiveObject();
        var hasActive = !!activeInfo;

        var btnToggle = curPage.querySelector('[data-toggle-sentiment]');
        var btnDelete = curPage.querySelector('[data-delete-selected]');
        if(btnToggle) btnToggle.disabled = !hasActive;
        if(btnDelete) btnDelete.disabled = !hasActive;

        renderRegionList(`${attr}-1`);
        renderRegionList(`${attr}-2`);
    }

    // *** ÊøÄÊ¥ªÂ∑•ÂÖ∑Ê†èÊåâÈíÆ ***
    function setupFabricControls() {
        qa('[data-toggle-sentiment]').forEach(btn => {
            btn.addEventListener('click', function() {
                var info = getGlobalActiveObject();
                if(info) {
                    var act = info.object;
                    act.sentiment = (act.sentiment === 'positive' ? 'negative' : 'positive');
                    act.set(act.sentiment === 'positive' ? COLORS.pos : COLORS.neg);
                    info.canvas.requestRenderAll();
                    pushPageAction(info.key);
                    saveHistory(info.key);
                    updateUIState();
                }
            });
        });

        qa('[data-delete-selected]').forEach(btn => {
            btn.addEventListener('click', function() {
                var info = getGlobalActiveObject();
                if(info) {
                    info.canvas.remove(info.object);
                    info.canvas.discardActiveObject();
                    info.canvas.requestRenderAll();
                    pushPageAction(info.key);
                    saveHistory(info.key);
                    updateUIState();
                }
            });
        });

        qa('[data-undo]').forEach(btn => {
            btn.addEventListener('click', performGlobalUndo);
        });

        qa('[data-clear]').forEach(btn => {
            btn.addEventListener('click', function() {
                if(!confirm("Are you sure you want to clear all regions on this page?")) return;
                var curPage = document.querySelector('.page.active');
                var attr = ATTRIBUTES[parseInt(curPage.dataset.attrIndex)];
                
                [`${attr}-1`, `${attr}-2`].forEach(key => {
                    var c = fabricCanvases[key];
                    if(c) {
                        c.clear();
                        c.isDrawingMode = true;
                        pushPageAction(key);
                        saveHistory(key);
                    }
                });
                updateUIState();
            });
        });
    }

    function extractPointsFromPath(pathObj) {
        var points = [];
        var cmds = pathObj.path;
        cmds.forEach(cmd => {
            var len = cmd.length;
            if (len >= 3) points.push({ x: cmd[len-2], y: cmd[len-1] });
        });
        return points;
    }

    function downsamplePoints(points, w, h) {
        if (points.length < 5) return points; 
        var result = [];
        var lastX = -999, lastY = -999;
        var threshold = 0.02; // 2% Ë∑ùÁ¶ªÈòàÂÄº

        points.forEach(p => {
            var nx = Math.round((p.x / w) * 1000) / 1000;
            var ny = Math.round((p.y / h) * 1000) / 1000;
            var dist = Math.sqrt(Math.pow(nx - lastX, 2) + Math.pow(ny - lastY, 2));
            if (dist > threshold) {
                result.push([nx, ny]);
                lastX = nx; lastY = ny;
            }
        });
        
        if (result.length < 3 && points.length >= 3) {
             return [
                 [Math.round(points[0].x/w*1000)/1000, Math.round(points[0].y/h*1000)/1000],
                 [Math.round(points[Math.floor(points.length/2)].x/w*1000)/1000, Math.round(points[Math.floor(points.length/2)].y/h*1000)/1000],
                 [Math.round(points[points.length-1].x/w*1000)/1000, Math.round(points[points.length-1].y/h*1000)/1000]
             ];
        }
        return result;
    }

    function collectCanvasData(attr) {
        ['1', '2'].forEach(idx => {
            var k = idx + '.jpg';
            var c = fabricCanvases[`${attr}-${idx}`];
            if (!c) return;
            var w = c.width;
            var h = c.height;
            var savedRegions = [];
            c.getObjects().forEach(obj => {
                if (obj.points) {
                    var compactPoints = downsamplePoints(obj.points, w, h);
                    savedRegions.push({
                        points: compactPoints,
                        sentiment: obj.sentiment || 'positive'
                    });
                }
            });
            state.points[attr][k] = savedRegions;
        });
    }

    // --- È°µÈù¢ÂØºËà™ ---
    document.addEventListener('click', function(e) {
        var btn = e.target.closest('button');
        if (!btn) return;

        if (btn.dataset.next) {
            var curPage = document.querySelector('.page.active');
            var nextId = btn.dataset.next;

            if (curPage.id === 'page-1') {
                var missing = [];
                if(!q('#user-id').value) missing.push('User ID');
                if(!q('#age').value) missing.push('Age');
                if(!q('#gender').value) missing.push('Gender');
                if(!q('#nationality').value) missing.push('Nationality');
                
                if(missing.length) { 
                    showDialog("Action Required: Missing Information", "Please fill in the following fields:\n\n‚Ä¢ " + missing.join('\n‚Ä¢ ')); 
                    return; 
                }
                state.demographics = {
                    id: q('#user-id').value,
                    age: q('#age').value,
                    gender: q('#gender').value,
                    nationality: q('#nationality').value,
                    education: q('#education').value || "Not specified"
                };
            }

            if (curPage.querySelector('.rating-list')) {
                var attr = ATTRIBUTES[parseInt(curPage.dataset.attrIndex)];
                if (state.pairwise[attr] === undefined) {
                    showDialog("Action Required: Rating", "Please select one of the options to compare the images.");
                    return;
                }
            }

            if (curPage.querySelector('canvas')) {
                var attr = ATTRIBUTES[parseInt(curPage.dataset.attrIndex)];
                collectCanvasData(attr);
                var totalRegions = state.points[attr]['1.jpg'].length + state.points[attr]['2.jpg'].length;
                var checkboxes = Array.from(document.querySelectorAll(`#global-${attr} input:checked`));
                var globalVals = checkboxes.map(cb => cb.value === "None" ? "No specific reason" : cb.value);
                state.global_factors[attr] = globalVals;

                if (totalRegions === 0 && globalVals.length === 0) {
                    showDialog("Logic Requirement", 
                        "Please provide your reasoning by either:\n\n" +
                        "1. Drawing circles around specific objects in the images.\n" +
                        "   ‚Äî OR ‚Äî\n" +
                        "2. Selecting a 'Global atmospheric factor' at the bottom (e.g., Lighting, Layout, or No specific reason).");
                    return; 
                }
            }

            if (curPage.id === 'page-check') {
                var a1 = q('#qc-ans-1').value;
                var a2 = q('#qc-ans-2').value;
                var a3 = q('#qc-ans-3').value;
                var pref = q('input[name="preference"]:checked');
                var missingQC = [];
                if(!a1) missingQC.push("Image Pair 1");
                if(!a2) missingQC.push("Image Pair 2");
                if(!a3) missingQC.push("Image Pair 3");
                if(!pref) missingQC.push("General Preference");
                if (missingQC.length > 0) {
                    showDialog("Action Required: Incomplete Selection", 
                        "Please complete all the choices to proceed:\n\n‚Ä¢ " + missingQC.join("\n‚Ä¢ "));
                    return;
                }
                state.quality_check = { q1: a1, q2: a2, q3: a3, preference: pref.value };
            }

            showPage(nextId);
        }

        if (btn.dataset.go) showPage(btn.dataset.go);

        if (btn.hasAttribute('data-back-to-rating')) {
            var curPage = document.querySelector('.page.active');
            var idx = parseInt(curPage.dataset.attrIndex);
            var target = 2 + idx * 2;
            if (idx >= 3) target += 1;
            showPage(target);
        }

        if (btn.id === 'finish') submitData();
    });

    window.selectQC = function(qIndex, answer) {
        var row = document.getElementById('qc-row-' + qIndex);
        row.querySelectorAll('.check-img-wrap').forEach(w => w.classList.remove('selected'));
        var clickedImg = document.getElementById('qc-img-' + qIndex + '-' + answer);
        if (clickedImg) clickedImg.parentElement.classList.add('selected');
        document.getElementById('qc-ans-' + qIndex).value = answer;
    };

    function showPage(idSuffix) {
        qa('.page').forEach(p => p.classList.remove('active'));
        var next = document.getElementById('page-' + idSuffix);
        if(next) {
            next.classList.add('active');
            window.scrollTo(0,0);
            if (idSuffix == 15) renderSummary(); 
            if(next.dataset.attrIndex && next.querySelector('canvas')) {
                var a = ATTRIBUTES[parseInt(next.dataset.attrIndex)];
                setTimeout(() => { initFabricCanvasForPage(a); }, 150);
            }
        }
    }

    // *** Ê∏≤Êüì Review (ÊñáÂ≠ó‰ºòÂåñÁâà) ***
    function renderSummary() {
        var c = q('#summary-container');
        var d = state.demographics;
        var qc = state.quality_check;
        
        var html = `
        <div style="padding:24px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:24px; font-size:15px;">
            <h3 style="margin-top:0">Participant Profile</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr; gap:12px;">
                <div><strong>ID:</strong> ${d.id}</div>
                <div><strong>Age/Gender:</strong> ${d.age} / ${d.gender}</div>
                <div><strong>Nationality:</strong> ${d.nationality}</div>
                <div><strong>Education:</strong> ${d.education}</div>
            </div>
        </div>
        
        <div style="padding:24px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;margin-bottom:24px; font-size:15px;">
            <h3 style="margin-top:0">Environment Classification</h3>
            <div><strong>Image Sorting Choices:</strong> ${qc.q1}, ${qc.q2}, ${qc.q3}</div>
            <div><strong>General Preference:</strong> ${qc.preference || '-'}</div>
        </div>`;

        html += '<h3 style="margin-bottom:12px;">Perception Ratings</h3><table class="summary-table"><thead><tr><th>Attribute</th><th>Rating</th><th>Regions (Pos/Neg)</th><th>Global Factors</th></tr></thead><tbody>';
        
        ATTRIBUTES.forEach(attr => {
            var val = state.pairwise[attr];
            var rText = (val===1)?'Left++':(val===0.5)?'Left+':(val===0)?'Equal':(val===-0.5)?'Right+':'Right++';
            
            var pos = 0, neg = 0;
            ['1.jpg','2.jpg'].forEach(k => {
                (state.points[attr][k]||[]).forEach(r => r.sentiment==='negative'?neg++:pos++);
            });
            var gf = (state.global_factors[attr]||[]).join(', ') || '-';
            
            html += `<tr><td>${attr}</td><td>${rText}</td><td><span style="color:#22c55e">${pos}</span> / <span style="color:#ef4444">${neg}</span></td><td>${gf}</td></tr>`;
        });
        html += '</tbody></table>';
        c.innerHTML = html;
    }

    function submitData() {
        var btn = q('#finish');
        btn.disabled = true; 
        
        var overlay = q('#submit-overlay');
        overlay.classList.add('show');
        q('#submit-overlay-message').textContent = 'Uploading data...';
        
        var payload = {
            demographics: state.demographics,
            pairwise: state.pairwise,
            points: state.points,
            global_factors: state.global_factors,
            quality_check: state.quality_check,
            pair_ids: assignedPairInfo ? [assignedPairInfo.pair_id] : [],
            meta: { timestamp: new Date().toISOString() }
        };
        
        var formData = new URLSearchParams();
        formData.append('payload', JSON.stringify(payload));

        fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            // *** UIÊõ¥Êñ∞ÔºöÂ±ïÁ§∫Êèê‰∫§ÂõûÊâß ***
            q('#submit-overlay-message').textContent = 'Submission Complete!';
            q('#submit-overlay-status').textContent = 'Reference ID: ' + (data.submissionId || 'OK');
            
            q('#submit-overlay-confirm').style.display = 'inline-block';
            q('.spinner').style.display = 'none';
            
            q('#submit-overlay-confirm').onclick = () => {
                overlay.classList.remove('show');
                // Â°´ÂÖÖÂõûÊâßÂå∫Âüü
                q('#submission-receipt').style.display = 'block';
                q('#receipt-content').innerHTML = `
                    <strong>Reference ID:</strong> ${data.submissionId}<br>
                    <strong>User ID:</strong> ${state.demographics.id}<br>
                    <strong>Time:</strong> ${new Date().toLocaleString()}
                `;
                // ‰øÆÊîπÊåâÈíÆÁä∂ÊÄÅ
                btn.textContent = "Data Submitted";
                btn.disabled = true;
                window.scrollTo(0, document.body.scrollHeight);
            };
        })
        .catch(err => {
            q('#submit-overlay-message').textContent = 'Error during upload.';
            q('#submit-overlay-status').textContent = err.message;
            q('.spinner').style.borderTopColor = '#ef4444';
            
            var a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'}));
            a.download = state.demographics.id + '_backup.json';
            a.click();
            
            alert("Upload failed. A backup file has been downloaded automatically.");
            btn.disabled = false;
        });
    }

    // --- ÂêØÂä®ÁõëÂê¨ ---
    window.addEventListener('DOMContentLoaded', () => {
        buildRatingControls();
        setupFabricControls(); 
        
        var pid = getProlificPid();
        if(pid) {
            q('#user-id').value = pid;
            q('#user-id').readOnly = true;
            q('#user-id').style.background = '#e2e8f0';
        }
        
        requestAssignment();

        window.addEventListener('resize', () => {
             var cur = document.querySelector('.page.active');
             if(cur && cur.dataset.attrIndex && cur.querySelector('canvas')) {
                 var attr = ATTRIBUTES[parseInt(cur.dataset.attrIndex)];
                 initFabricCanvasForPage(attr); 
             }
        });
    });

})();
</script>
</body>
</html>
